---
/**
 * Seasonal Callout Bar
 * Sticky bar at the top of the page displaying seasonal messages
 * Automatically activates the correct seasonal message based on current date
 */

import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../../lib/getBusinessProfile';

const profile = await getBusinessProfile();
const seasonalMessages = await getCollection('seasonal-messages');

// Function to get the active seasonal message based on current date
function getActiveSeasonalMessage() {
  const now = new Date();
  const currentMonth = now.getMonth() + 1; // 1-12
  const currentDay = now.getDate();
  const currentDateStr = `${String(currentMonth).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;

  for (const message of seasonalMessages) {
    if (!message.data.enabled) continue;

    const { startDate, endDate } = message.data;

    // Handle year-wrap scenarios (e.g., winter: 12-01 to 02-28)
    if (startDate > endDate) {
      // Year wrap case
      if (currentDateStr >= startDate || currentDateStr <= endDate) {
        return message;
      }
    } else {
      // Normal case
      if (currentDateStr >= startDate && currentDateStr <= endDate) {
        return message;
      }
    }
  }

  return null;
}

const activeMessage = getActiveSeasonalMessage();

// If no active message, don't render the bar
if (!activeMessage) {
  return null;
}

const { message, icon } = activeMessage.data;

// Icon SVGs
const icons = {
  snowflake: `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v20M2 12h20M5.6 5.6l12.8 12.8M5.6 18.4L18.4 5.6M8 12l8 0M12 8v8" /></svg>`,
  sun: `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`,
  flame: `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" /></svg>`,
  leaf: `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>`,
};

const iconSvg = icon ? icons[icon] : '';
---

<div class="seasonal-callout-bar sticky top-0 z-50 bg-brand-blue text-white">
  <div class="mx-auto max-w-6xl px-4 py-2.5 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between gap-4">
      <!-- Left: Seasonal Message -->
      <div class="flex items-center gap-2 text-sm font-semibold">
        {iconSvg && <span set:html={iconSvg} />}
        <span>{message}</span>
      </div>

      <!-- Right: CTAs -->
      <div class="flex items-center gap-3">
        <!-- Primary CTA: Call -->
        <a
          href={`tel:${profile.contact.phone_e164}`}
          class="inline-flex items-center gap-2 rounded-md bg-white px-3 py-1.5 text-sm font-semibold text-brand-blue transition-all hover:bg-white/90 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-brand-blue"
          data-cta-context="seasonal-callout"
          aria-label={`Call us at ${profile.contact.phone_display}`}
        >
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
          <span class="hidden sm:inline">Call Now</span>
          <span class="sm:hidden">Call</span>
        </a>

        <!-- Secondary CTA: Book Online -->
        {profile.contact.booking.enabled && (
          <a
            href={profile.contact.booking.url}
            target="_blank"
            rel="noopener noreferrer"
            class="hidden sm:inline-flex items-center gap-2 rounded-md border-2 border-white px-3 py-1.5 text-sm font-semibold text-white transition-all hover:bg-white hover:text-brand-blue focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-brand-blue"
            data-cta-context="seasonal-callout"
          >
            <span>Book Online</span>
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        )}
      </div>
    </div>
  </div>
</div>

<style>
  .seasonal-callout-bar {
    /* Ensure no layout shift */
    will-change: transform;
  }
</style>
