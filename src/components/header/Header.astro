---
import { getBusinessProfile, getCompanyName, getPhoneLink } from '../../lib/getBusinessProfile';
import logo from '../../images/bapheatingandcoolingltd.webp';
import Button from '../primitives/Button.astro';

const profile = await getBusinessProfile();
const companyName = getCompanyName(profile);

// Map category keys to pillar page slugs
const categorySlugMap: { [key: string]: string } = {
  'heating': 'heating',
  'cooling': 'cooling',
  'iaq': 'indoor-air-quality',
  'water-heating': 'water-heating',
  'commercial': 'commercial',
  'plans': 'maintenance-plans',
};
---

<nav id="main-nav" class="sticky top-0 z-50 border-b bg-white transition-all duration-300" role="navigation" aria-label="Main navigation">
  <div class="mx-auto max-w-6xl px-4 py-4 sm:px-6 lg:px-8 transition-all duration-300">
    <!-- Desktop/Tablet Layout: Flexbox for proper spacing -->
    <div class="flex items-center justify-between gap-4">
      <!-- Logo (Left - Fixed Width) -->
      <div class="flex-shrink-0">
        <a href="/" class="block">
          <img
            src={logo.src}
            alt={companyName}
            class="h-auto w-full max-w-[100px]"
          />
        </a>
      </div>

      <!-- Desktop Navigation Links (Center - Takes available space, centered) -->
      <div class="hidden flex-1 justify-center lg:flex">
        <ul class="flex items-center gap-6">
          {profile.services.navbar_categories.map((category) => {
            const href = category.key === 'locations' ? '/locations/' :
                         category.key === 'contact' ? '/contact-us/' :
                         `/services/${categorySlugMap[category.key]}/`;
            return (
              <li>
                <a
                  href={href}
                  class="whitespace-nowrap text-sm font-medium text-muted-foreground transition-colors hover:text-foreground"
                >
                  {category.name}
                </a>
              </li>
            );
          })}
          <li>
            <a
              href="/reviews/"
              class="whitespace-nowrap text-sm font-medium text-muted-foreground transition-colors hover:text-foreground"
            >
              Reviews
            </a>
          </li>
        </ul>
      </div>

      <!-- Right Section (CTAs) - Fixed Width -->
      <div class="flex flex-shrink-0 items-center gap-3">
        <!-- Desktop CTA Button -->
        <Button
          variant="emergency"
          size="sm"
          href={getPhoneLink(profile)}
          data-cta-context="header"
          class="hidden lg:inline-flex"
        >
          <span>Call Us Now</span>
        </Button>

        <!-- Mobile: Phone CTA + Hamburger -->
        <Button
          variant="emergency"
          size="sm"
          href={getPhoneLink(profile)}
          data-cta-context="header-mobile"
          class="lg:hidden"
        >
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
          <span class="hidden sm:inline">Call</span>
        </Button>
        <button
          id="mobile-menu-button"
          type="button"
          class="inline-flex items-center justify-center rounded-md p-2 text-foreground hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary lg:hidden min-h-[44px] min-w-[44px]"
          aria-expanded="false"
          aria-label="Toggle navigation menu"
        >
          <!-- Hamburger Icon -->
          <svg id="hamburger-icon" class="h-6 w-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <!-- Close Icon (hidden by default) -->
          <svg id="close-icon" class="hidden h-6 w-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Navigation Menu (Full Width) -->
  <div id="mobile-menu" class="hidden border-t bg-white lg:hidden overflow-hidden transition-all duration-300 ease-in-out max-h-0 opacity-0" data-menu-closed>
    <div class="container mx-auto px-4">
      <ul class="space-y-1 pb-3 pt-4">
        {profile.services.navbar_categories.map((category) => {
          const href = category.key === 'locations' ? '/locations/' :
                       category.key === 'contact' ? '/contact-us/' :
                       `/services/${categorySlugMap[category.key]}/`;
          return (
            <li>
              <a
                href={href}
                class="block rounded-md px-3 py-2 text-base font-medium transition-colors hover:bg-muted"
              >
                {category.name}
              </a>
            </li>
          );
        })}
        <li>
          <a
            href="/reviews/"
            class="block rounded-md px-3 py-2 text-base font-medium transition-colors hover:bg-muted"
          >
            Reviews
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const menuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const hamburgerIcon = document.getElementById('hamburger-icon');
    const closeIcon = document.getElementById('close-icon');

    if (menuButton && mobileMenu && hamburgerIcon && closeIcon) {
      const openMenu = () => {
        mobileMenu.classList.remove('hidden');
        // Trigger reflow to enable CSS transition
        void mobileMenu.offsetHeight;
        mobileMenu.classList.remove('max-h-0', 'opacity-0');
        mobileMenu.classList.add('max-h-[500px]', 'opacity-100');
        mobileMenu.removeAttribute('data-menu-closed');
        menuButton.setAttribute('aria-expanded', 'true');

        // Toggle icons
        hamburgerIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
      };

      const closeMenu = () => {
        mobileMenu.classList.remove('max-h-[500px]', 'opacity-100');
        mobileMenu.classList.add('max-h-0', 'opacity-0');
        mobileMenu.setAttribute('data-menu-closed', '');
        menuButton.setAttribute('aria-expanded', 'false');

        // Toggle icons
        hamburgerIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');

        // Hide after animation completes
        setTimeout(() => {
          if (mobileMenu.hasAttribute('data-menu-closed')) {
            mobileMenu.classList.add('hidden');
          }
        }, 300);
      };

      menuButton.addEventListener('click', () => {
        const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          closeMenu();
        } else {
          openMenu();
        }
      });

      // Close menu when clicking a link
      const menuLinks = mobileMenu.querySelectorAll('a');
      menuLinks.forEach(link => {
        link.addEventListener('click', closeMenu);
      });

      // Close menu when clicking outside
      document.addEventListener('click', (event) => {
        const target = event.target as HTMLElement;
        if (!menuButton.contains(target) && !mobileMenu.contains(target)) {
          const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
          if (isExpanded) {
            closeMenu();
          }
        }
      });
    }
  });

  // Sticky header scroll behavior
  const nav = document.getElementById('main-nav');
  let lastScroll = 0;
  const scrollThreshold = 100; // Pixels to scroll before adding effects

  if (nav) {
    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset;

      if (currentScroll > scrollThreshold) {
        // Add shadow and slight padding reduction when scrolled
        nav.classList.add('shadow-md');
        nav.querySelector('div')?.classList.remove('py-4');
        nav.querySelector('div')?.classList.add('py-2');
      } else {
        // Remove effects when at top
        nav.classList.remove('shadow-md');
        nav.querySelector('div')?.classList.add('py-4');
        nav.querySelector('div')?.classList.remove('py-2');
      }

      lastScroll = currentScroll;
    });
  }
</script>
