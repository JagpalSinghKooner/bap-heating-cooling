---
/**
 * Gallery Section - Carousel with Trust Signals
 * Horizontal scroller showing 3 images at a time with overlay text and trust pills
 */

import Section from '../primitives/Section.astro';

const projects = [
  {
    id: 'furnace-install',
    title: 'Emergency Furnace Replacement',
    location: 'Guelph, ON',
    trustSignal: 'Saved 20% on bills',
    image: '/images/services/furnace-installation.jpg',
  },
  {
    id: 'heatpump-install',
    title: 'Heat Pump Upgrade',
    location: 'Cambridge, ON',
    trustSignal: 'Saved 35% on heating',
    image: '/images/services/ac-unit-maintenance.jpg',
  },
  {
    id: 'ac-install',
    title: 'AC Installation',
    location: 'Kitchener, ON',
    trustSignal: 'Saved 25% on cooling',
    image: '/images/services/hvac-repair-rooftop.jpg',
  },
  {
    id: 'commercial-hvac',
    title: 'Commercial Rooftop Unit',
    location: 'Waterloo, ON',
    trustSignal: '40% energy reduction',
    image: '/images/services/commercial-hvac.jpg',
  },
  {
    id: 'indoor-air',
    title: 'Indoor Air Quality System',
    location: 'Fergus, ON',
    trustSignal: '89% better air quality',
    image: '/images/services/indoor-air-quality.jpg',
  },
  {
    id: 'furnace-repair',
    title: 'Same-Day Furnace Repair',
    location: 'Elora, ON',
    trustSignal: 'Fixed in 2 hours',
    image: '/images/services/furnace-installation.jpg',
  },
];
---

<Section variant="muted">
  <!-- Section Header -->
  <div class="mb-10 text-center">
    <p class="eyebrow mb-3">Our Work</p>
    <h2 class="section-title mx-auto mb-4 max-w-3xl">
      Real results for real homeowners
    </h2>
    <p class="mx-auto max-w-2xl text-base text-muted-foreground">
      See the quality of our installations and repairs. Every project completed with care and backed by our 10-year warranty.
    </p>
  </div>

  <!-- Gallery Carousel -->
  <div class="relative overflow-hidden" data-gallery-carousel>
    <div class="gallery-track flex gap-6 transition-transform duration-500 ease-out" data-gallery-track>
      {projects.map((project) => (
        <div class="gallery-slide w-full flex-shrink-0 md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)]">
          <div class="group relative aspect-[4/3] overflow-hidden rounded-2xl">
            <!-- Image -->
            <img
              src={project.image}
              alt={project.title}
              class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
              loading="lazy"
            />

            <!-- Trust Signal Pill - Top Right -->
            <div class="absolute top-4 right-4 z-10">
              <span class="inline-flex items-center gap-1.5 rounded-full bg-green-500 px-3 py-1.5 text-xs font-bold text-white shadow-lg">
                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                {project.trustSignal}
              </span>
            </div>

            <!-- Dark Gradient Overlay -->
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>

            <!-- Text Content - Bottom -->
            <div class="absolute inset-x-0 bottom-0 p-5">
              <p class="mb-1 text-sm font-medium text-white/80">
                {project.location}
              </p>
              <h3 class="text-lg font-bold text-white sm:text-xl">
                {project.title}
              </h3>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Pagination Dots + Navigation Arrows -->
  <div class="mt-8 flex items-center justify-center gap-4">
    <!-- Dots -->
    <div class="flex items-center gap-2" data-gallery-dots>
      {projects.map((_, index) => (
        <button
          type="button"
          class="gallery-dot h-2 w-2 rounded-full bg-border transition-all hover:bg-primary"
          aria-label={`Go to slide ${index + 1}`}
          data-dot={index}
        ></button>
      ))}
    </div>

    <!-- Navigation Arrows -->
    <div class="flex gap-2">
      <button
        type="button"
        class="gallery-prev flex h-10 w-10 items-center justify-center rounded-full border border-border bg-background text-foreground shadow-sm transition-all hover:border-primary hover:bg-primary hover:text-white disabled:opacity-50"
        aria-label="Previous"
        data-gallery-prev
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button
        type="button"
        class="gallery-next flex h-10 w-10 items-center justify-center rounded-full border border-border bg-background text-foreground shadow-sm transition-all hover:border-primary hover:bg-primary hover:text-white disabled:opacity-50"
        aria-label="Next"
        data-gallery-next
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</Section>

<script>
  function initGalleryCarousel() {
    const carousel = document.querySelector('[data-gallery-carousel]');
    const track = document.querySelector('[data-gallery-track]') as HTMLElement;
    const prevBtn = document.querySelector('[data-gallery-prev]') as HTMLButtonElement;
    const nextBtn = document.querySelector('[data-gallery-next]') as HTMLButtonElement;
    const dots = document.querySelectorAll('[data-dot]');

    if (!carousel || !track) return;

    const slides = track.querySelectorAll('.gallery-slide');
    let currentIndex = 0;
    let slidesPerView = 3;

    // Determine slides per view based on screen width
    function updateSlidesPerView() {
      if (window.innerWidth < 768) {
        slidesPerView = 1;
      } else if (window.innerWidth < 1024) {
        slidesPerView = 2;
      } else {
        slidesPerView = 3;
      }
    }

    // Calculate max index
    function getMaxIndex() {
      return Math.max(0, slides.length - slidesPerView);
    }

    // Update carousel position
    function updateCarousel() {
      const slideWidth = 100 / slidesPerView;
      const gap = 24; // 6 * 4px (gap-6)
      const offset = currentIndex * (slideWidth + (gap / track.offsetWidth * 100));
      track.style.transform = `translateX(-${currentIndex * (100 / slidesPerView + 1.5)}%)`;

      // Update dots
      dots.forEach((dot, i) => {
        if (i === currentIndex) {
          dot.classList.add('bg-primary', 'w-6');
          dot.classList.remove('bg-border', 'w-2');
        } else {
          dot.classList.remove('bg-primary', 'w-6');
          dot.classList.add('bg-border', 'w-2');
        }
      });

      // Update button states
      if (prevBtn) prevBtn.disabled = currentIndex === 0;
      if (nextBtn) nextBtn.disabled = currentIndex >= getMaxIndex();
    }

    // Navigation
    function goToSlide(index: number) {
      currentIndex = Math.max(0, Math.min(index, getMaxIndex()));
      updateCarousel();
    }

    function nextSlide() {
      goToSlide(currentIndex + 1);
    }

    function prevSlide() {
      goToSlide(currentIndex - 1);
    }

    // Event listeners
    if (prevBtn) prevBtn.addEventListener('click', prevSlide);
    if (nextBtn) nextBtn.addEventListener('click', nextSlide);

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => goToSlide(index));
    });

    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    track.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    track.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) nextSlide();
        else prevSlide();
      }
    }, { passive: true });

    // Handle resize
    window.addEventListener('resize', () => {
      updateSlidesPerView();
      goToSlide(Math.min(currentIndex, getMaxIndex()));
    });

    // Initialize
    updateSlidesPerView();
    updateCarousel();
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGalleryCarousel);
  } else {
    initGalleryCarousel();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initGalleryCarousel);
</script>

<style>
  .gallery-dot {
    transition: all 0.3s ease;
  }

  .gallery-dot.bg-primary {
    width: 1.5rem;
  }

  .gallery-prev:hover svg,
  .gallery-next:hover svg {
    color: white;
  }
</style>
