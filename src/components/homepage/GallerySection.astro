---
/**
 * GallerySection Component - Homepage
 *
 * A showcase of B.A.P's completed projects with before/after capability.
 * This section builds trust by showing real work, real results.
 *
 * Design Philosophy:
 * When someone is about to spend thousands on HVAC work, they want proof.
 * This isn't a generic "gallery" - it's a transformation showcase.
 * Each project tells a story: the problem, the solution, the result.
 *
 * Aesthetic Direction:
 * - "Industrial Blueprint" vibe with subtle grid overlay
 * - Before/after slider creates interactive engagement
 * - Warm muted background to stand out from default sections
 * - Strong stats overlay shows measurable results
 * - Navigation feels mechanical and precise (industrial controls)
 *
 * Features:
 * - Before/after comparison slider (touch-enabled)
 * - Project details overlay
 * - Horizontal carousel with snap scrolling
 * - Navigation arrows and pagination dots
 * - Responsive: 1 card mobile, 2 tablet, 3 desktop
 *
 * Data Sources:
 * - Case studies collection (when available)
 * - Fallback to hardcoded showcase projects
 */

import Section from '../primitives/Section.astro';
import Container from '../primitives/Container.astro';
import SectionHeader from '../primitives/SectionHeader.astro';
import Button from '../primitives/Button.astro';
import Badge from '../primitives/Badge.astro';
import { getIconPath } from '../../lib/icons';

interface Project {
  id: string;
  title: string;
  location: string;
  category: string;
  beforeImage: string;
  afterImage: string;
  description: string;
  equipment?: string;
  stats?: Array<{ value: string; label: string }>;
}

interface Props {
  /** Custom headline override */
  headline?: string;
  /** Custom description override */
  description?: string;
  /** Projects to display (overrides default) */
  projects?: Project[];
  /** Show CTA button at bottom */
  showCTA?: boolean;
  /** Custom CTA label */
  ctaLabel?: string;
  /** Custom CTA href */
  ctaHref?: string;
  /** Section variant for background */
  sectionVariant?: 'default' | 'muted' | 'warm';
  /** Additional classes */
  class?: string;
}

const {
  headline = 'Our Work in Action',
  description = 'See the transformations we\'ve delivered for homeowners across the region. Real projects, real results, real comfort.',
  projects,
  showCTA = true,
  ctaLabel = 'View All Projects',
  ctaHref = '/about-us/',
  sectionVariant = 'default',
  class: className = '',
} = Astro.props;

// Default showcase projects with before/after images
const defaultProjects: Project[] = [
  {
    id: 'furnace-guelph-1',
    title: 'High-Efficiency Furnace Upgrade',
    location: 'Guelph, ON',
    category: 'Heating',
    beforeImage: '/images/projects/furnace-before-1.jpg',
    afterImage: '/images/projects/furnace-after-1.jpg',
    description: 'Replaced 25-year-old mid-efficiency furnace with Lennox SL280V variable-speed system.',
    equipment: 'Lennox SL280V (96% AFUE)',
    stats: [
      { value: '42%', label: 'Lower Bills' },
      { value: '10 Yr', label: 'Warranty' },
    ],
  },
  {
    id: 'ac-cambridge-1',
    title: 'Central AC Installation',
    location: 'Cambridge, ON',
    category: 'Cooling',
    beforeImage: '/images/projects/ac-before-1.jpg',
    afterImage: '/images/projects/ac-after-1.jpg',
    description: 'First-time central AC installation in 1960s split-level home with custom ductwork.',
    equipment: 'Carrier Infinity 24ANB1',
    stats: [
      { value: '21 SEER', label: 'Efficiency' },
      { value: '1 Day', label: 'Install Time' },
    ],
  },
  {
    id: 'furnace-kitchener-1',
    title: 'Emergency Furnace Replacement',
    location: 'Kitchener, ON',
    category: 'Heating',
    beforeImage: '/images/projects/furnace-before-2.jpg',
    afterImage: '/images/projects/furnace-after-2.jpg',
    description: 'Same-day replacement when old furnace failed during cold snap. Family warm by dinner.',
    equipment: 'Goodman GMVC96 Two-Stage',
    stats: [
      { value: '8 Hrs', label: 'Turnaround' },
      { value: '35%', label: 'Energy Savings' },
    ],
  },
  {
    id: 'tankless-waterloo-1',
    title: 'Tankless Water Heater',
    location: 'Waterloo, ON',
    category: 'Water Heating',
    beforeImage: '/images/projects/tankless-before-1.jpg',
    afterImage: '/images/projects/tankless-after-1.jpg',
    description: 'Upgraded from 40-gallon tank to on-demand system. Endless hot water, smaller footprint.',
    equipment: 'Navien NPE-240A',
    stats: [
      { value: '0.96', label: 'EF Rating' },
      { value: 'âˆž', label: 'Hot Water' },
    ],
  },
];

const displayProjects = projects || defaultProjects;
const uniqueId = `gallery-${Math.random().toString(36).substr(2, 9)}`;
---

<Section variant={sectionVariant} padding="lg" class={`gallery-section ${className}`}>
  {/* Blueprint grid overlay - industrial aesthetic */}
  <div class="gallery-blueprint-grid" aria-hidden="true"></div>

  <Container size="xl">
    {/* Section Header */}
    <SectionHeader
      eyebrow="Project Showcase"
      headline={headline}
      description={description}
      align="center"
      headlineSize="lg"
      maxWidth="lg"
    />

    {/* Gallery Carousel */}
    <div class="gallery-carousel-wrapper">
      {/* Navigation Arrows */}
      <button
        class="gallery-nav gallery-nav-prev"
        data-gallery-prev={uniqueId}
        aria-label="Previous project"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="gallery-nav-icon">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <button
        class="gallery-nav gallery-nav-next"
        data-gallery-next={uniqueId}
        aria-label="Next project"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="gallery-nav-icon">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      {/* Carousel Track */}
      <div class="gallery-carousel" id={uniqueId} role="region" aria-label="Project gallery">
        <div class="gallery-track">
          {displayProjects.map((project, index) => (
            <article class="gallery-card" data-index={index}>
              {/* Before/After Image Container */}
              <div class="gallery-comparison">
                {/* After Image (Bottom Layer) */}
                <div class="gallery-image gallery-image-after">
                  <img
                    src={project.afterImage}
                    alt={`${project.title} - After`}
                    loading={index < 2 ? 'eager' : 'lazy'}
                    onerror="this.src='/images/placeholder-project.jpg'"
                  />
                  <span class="gallery-image-label gallery-label-after">After</span>
                </div>

                {/* Before Image (Top Layer with Clip) */}
                <div class="gallery-image gallery-image-before" data-before-container>
                  <img
                    src={project.beforeImage}
                    alt={`${project.title} - Before`}
                    loading={index < 2 ? 'eager' : 'lazy'}
                    onerror="this.src='/images/placeholder-project.jpg'"
                  />
                  <span class="gallery-image-label gallery-label-before">Before</span>
                </div>

                {/* Slider Handle */}
                <div class="gallery-slider" data-slider>
                  <div class="gallery-slider-line"></div>
                  <div class="gallery-slider-handle">
                    <svg viewBox="0 0 24 24" fill="none" class="gallery-slider-icon">
                      <path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M8 12h8M8 12l3-3M8 12l3 3M16 12l-3-3M16 12l-3 3" />
                    </svg>
                  </div>
                </div>

                {/* Category Badge */}
                <div class="gallery-category">
                  <Badge variant="primary" size="sm">{project.category}</Badge>
                </div>
              </div>

              {/* Project Info */}
              <div class="gallery-info">
                <div class="gallery-info-header">
                  <h3 class="gallery-title">{project.title}</h3>
                  <p class="gallery-location">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="gallery-location-icon">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    {project.location}
                  </p>
                </div>

                <p class="gallery-description">{project.description}</p>

                {project.equipment && (
                  <p class="gallery-equipment">
                    <span class="gallery-equipment-label">Installed:</span>
                    {project.equipment}
                  </p>
                )}

                {/* Stats Row */}
                {project.stats && project.stats.length > 0 && (
                  <div class="gallery-stats">
                    {project.stats.map((stat) => (
                      <div class="gallery-stat">
                        <span class="gallery-stat-value">{stat.value}</span>
                        <span class="gallery-stat-label">{stat.label}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </article>
          ))}
        </div>
      </div>
    </div>

    {/* Pagination Dots */}
    <div class="gallery-pagination" role="tablist" aria-label="Project navigation">
      {displayProjects.map((_, index) => (
        <button
          class={`gallery-dot ${index === 0 ? 'gallery-dot-active' : ''}`}
          data-gallery-dot={uniqueId}
          data-index={index}
          role="tab"
          aria-selected={index === 0 ? 'true' : 'false'}
          aria-label={`Go to project ${index + 1}`}
        />
      ))}
    </div>

    {/* CTA */}
    {showCTA && (
      <div class="gallery-cta">
        <Button
          variant="secondary"
          size="md"
          href={ctaHref}
          iconRight="arrowRight"
          data-cta-context="homepage-gallery"
        >
          {ctaLabel}
        </Button>
      </div>
    )}
  </Container>

  {/* Decorative corner accents */}
  <div class="gallery-accent gallery-accent-tl" aria-hidden="true"></div>
  <div class="gallery-accent gallery-accent-br" aria-hidden="true"></div>
</Section>

<style is:global>
  /**
   * GallerySection Styles
   *
   * Industrial Blueprint aesthetic with before/after comparison sliders.
   * Creates an engaging, interactive showcase of B.A.P's work.
   */

  /* ============================================
     BASE SECTION
     ============================================ */

  .gallery-section {
    position: relative;
    overflow: hidden;
  }

  /* Blueprint grid background - subtle industrial texture */
  .gallery-blueprint-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(var(--color-primary-100) 1px, transparent 1px),
      linear-gradient(90deg, var(--color-primary-100) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
    pointer-events: none;
    mask-image: radial-gradient(ellipse 80% 50% at 50% 50%, black 20%, transparent 70%);
    -webkit-mask-image: radial-gradient(ellipse 80% 50% at 50% 50%, black 20%, transparent 70%);
  }

  /* ============================================
     CAROUSEL WRAPPER
     ============================================ */

  .gallery-carousel-wrapper {
    position: relative;
    margin-top: var(--space-12);
    padding: 0 var(--space-12);
  }

  @media (max-width: 768px) {
    .gallery-carousel-wrapper {
      margin-top: var(--space-8);
      padding: 0;
    }
  }

  /* ============================================
     CAROUSEL TRACK
     ============================================ */

  .gallery-carousel {
    overflow: hidden;
    border-radius: var(--radius-xl);
  }

  .gallery-track {
    display: flex;
    gap: var(--space-6);
    transition: transform var(--duration-slow) var(--ease-out);
  }

  /* ============================================
     GALLERY CARD
     ============================================ */

  .gallery-card {
    flex: 0 0 calc(33.333% - var(--space-4));
    min-width: 0;
    background: var(--color-surface-primary);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--color-border-primary);
    transition:
      transform var(--duration-normal) var(--ease-out),
      box-shadow var(--duration-normal) var(--ease-out);
  }

  .gallery-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
  }

  @media (max-width: 1024px) {
    .gallery-card {
      flex: 0 0 calc(50% - var(--space-3));
    }
  }

  @media (max-width: 640px) {
    .gallery-card {
      flex: 0 0 100%;
    }
  }

  /* ============================================
     BEFORE/AFTER COMPARISON
     ============================================ */

  .gallery-comparison {
    position: relative;
    aspect-ratio: 4 / 3;
    overflow: hidden;
    cursor: ew-resize;
    background: var(--color-surface-tertiary);
  }

  .gallery-image {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .gallery-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .gallery-image-before {
    clip-path: inset(0 50% 0 0);
    z-index: 2;
  }

  .gallery-image-after {
    z-index: 1;
  }

  /* Image labels */
  .gallery-image-label {
    position: absolute;
    bottom: var(--space-3);
    padding: var(--space-1) var(--space-3);
    font-family: var(--font-family-heading);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
    letter-spacing: var(--letter-spacing-wide);
    text-transform: uppercase;
    border-radius: var(--radius-sm);
    z-index: 5;
  }

  .gallery-label-before {
    left: var(--space-3);
    background: rgba(15, 23, 42, 0.8);
    color: var(--color-text-inverse);
  }

  .gallery-label-after {
    right: var(--space-3);
    background: rgba(22, 163, 74, 0.9);
    color: white;
  }

  /* ============================================
     SLIDER CONTROL
     ============================================ */

  .gallery-slider {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 50%;
    width: 4px;
    z-index: 10;
    transform: translateX(-50%);
    cursor: ew-resize;
  }

  .gallery-slider-line {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 50%;
    width: 2px;
    background: white;
    transform: translateX(-50%);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
  }

  .gallery-slider-handle {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: var(--radius-full);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform var(--duration-fast) var(--ease-out);
  }

  .gallery-slider-handle:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .gallery-slider-icon {
    width: 20px;
    height: 20px;
    color: var(--color-primary-600);
  }

  /* ============================================
     CATEGORY BADGE
     ============================================ */

  .gallery-category {
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    z-index: 15;
  }

  /* ============================================
     PROJECT INFO
     ============================================ */

  .gallery-info {
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .gallery-info-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .gallery-title {
    font-family: var(--font-family-heading);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    line-height: var(--line-height-tight);
    margin: 0;
  }

  .gallery-location {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-family: var(--font-family-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .gallery-location-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
  }

  .gallery-description {
    font-family: var(--font-family-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin: 0;
  }

  .gallery-equipment {
    font-family: var(--font-family-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
    padding-top: var(--space-2);
    border-top: 1px solid var(--color-border-secondary);
  }

  .gallery-equipment-label {
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
  }

  /* ============================================
     STATS ROW
     ============================================ */

  .gallery-stats {
    display: flex;
    gap: var(--space-4);
    padding-top: var(--space-3);
    margin-top: auto;
    border-top: 1px dashed var(--color-border-primary);
  }

  .gallery-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    flex: 1;
  }

  .gallery-stat-value {
    font-family: var(--font-family-heading);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary-600);
    line-height: 1;
  }

  .gallery-stat-label {
    font-family: var(--font-family-body);
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    margin-top: var(--space-1);
  }

  /* ============================================
     NAVIGATION ARROWS
     ============================================ */

  .gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    background: var(--color-surface-primary);
    border: 2px solid var(--color-border-primary);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    box-shadow: var(--shadow-md);
    transition:
      background-color var(--duration-fast) var(--ease-out),
      border-color var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
  }

  .gallery-nav:hover {
    background: var(--color-primary-50);
    border-color: var(--color-primary-300);
    transform: translateY(-50%) scale(1.05);
  }

  .gallery-nav:active {
    transform: translateY(-50%) scale(0.98);
  }

  .gallery-nav:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: 2px;
  }

  .gallery-nav:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: translateY(-50%);
  }

  .gallery-nav:disabled:hover {
    background: var(--color-surface-primary);
    border-color: var(--color-border-primary);
  }

  .gallery-nav-prev {
    left: 0;
  }

  .gallery-nav-next {
    right: 0;
  }

  .gallery-nav-icon {
    width: 20px;
    height: 20px;
    color: var(--color-primary-600);
  }

  @media (max-width: 768px) {
    .gallery-nav {
      display: none;
    }
  }

  /* ============================================
     PAGINATION DOTS
     ============================================ */

  .gallery-pagination {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-8);
  }

  .gallery-dot {
    position: relative;
    width: 44px;
    height: 44px;
    border-radius: var(--radius-full);
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  /* Visual dot rendered via pseudo-element */
  .gallery-dot::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 10px;
    height: 10px;
    border-radius: var(--radius-full);
    background: var(--color-border-primary);
    transform: translate(-50%, -50%);
    transition:
      background-color var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
  }

  .gallery-dot:hover::after {
    background: var(--color-primary-300);
    transform: translate(-50%, -50%) scale(1.2);
  }

  .gallery-dot:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: -4px;
  }

  .gallery-dot-active::after {
    background: var(--color-primary-600);
    transform: translate(-50%, -50%) scale(1.2);
  }

  /* ============================================
     CTA AREA
     ============================================ */

  .gallery-cta {
    display: flex;
    justify-content: center;
    margin-top: var(--space-10);
  }

  /* ============================================
     DECORATIVE ACCENTS
     Industrial corner brackets
     ============================================ */

  .gallery-accent {
    position: absolute;
    width: 60px;
    height: 60px;
    border: 3px solid var(--color-primary-200);
    opacity: 0.4;
    pointer-events: none;
  }

  .gallery-accent-tl {
    top: var(--space-6);
    left: var(--space-6);
    border-right: none;
    border-bottom: none;
  }

  .gallery-accent-br {
    bottom: var(--space-6);
    right: var(--space-6);
    border-left: none;
    border-top: none;
  }

  @media (max-width: 768px) {
    .gallery-accent {
      display: none;
    }
  }

  /* ============================================
     INVERSE SECTION SUPPORT
     ============================================ */

  .section-inverse .gallery-blueprint-grid {
    background-image:
      linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
    opacity: 0.5;
  }

  .section-inverse .gallery-card {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .section-inverse .gallery-nav {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .section-inverse .gallery-nav:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .section-inverse .gallery-nav-icon {
    color: var(--color-text-inverse);
  }

  .section-inverse .gallery-dot::after {
    background: rgba(255, 255, 255, 0.3);
  }

  .section-inverse .gallery-dot:hover::after {
    background: rgba(255, 255, 255, 0.5);
  }

  .section-inverse .gallery-dot-active::after {
    background: var(--color-accent-500);
  }

  .section-inverse .gallery-accent {
    border-color: rgba(255, 255, 255, 0.15);
  }

  /* ============================================
     ANIMATIONS
     ============================================ */

  .gallery-card {
    animation: galleryCardReveal var(--duration-slow) var(--ease-out) forwards;
    opacity: 0;
  }

  .gallery-card:nth-child(1) { animation-delay: 100ms; }
  .gallery-card:nth-child(2) { animation-delay: 200ms; }
  .gallery-card:nth-child(3) { animation-delay: 300ms; }
  .gallery-card:nth-child(4) { animation-delay: 400ms; }

  @keyframes galleryCardReveal {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ============================================
     REDUCED MOTION
     ============================================ */

  @media (prefers-reduced-motion: reduce) {
    .gallery-track {
      transition: none;
    }

    .gallery-card {
      animation: none;
      opacity: 1;
    }

    .gallery-slider-handle:hover {
      transform: translate(-50%, -50%);
    }
  }

  /* ============================================
     PRINT STYLES
     ============================================ */

  @media print {
    .gallery-blueprint-grid,
    .gallery-nav,
    .gallery-pagination,
    .gallery-accent,
    .gallery-slider {
      display: none;
    }

    .gallery-card {
      page-break-inside: avoid;
    }

    .gallery-image-before {
      clip-path: none;
    }

    .gallery-image-after {
      display: none;
    }
  }
</style>

<script>
  /**
   * GallerySection Interactive Features
   *
   * Handles:
   * - Before/after slider interaction (mouse + touch)
   * - Carousel navigation
   * - Pagination dots
   * - Touch swipe for mobile
   */

  document.addEventListener('DOMContentLoaded', () => {
    initializeGalleries();
  });

  // Also handle page transitions (for Astro's view transitions)
  document.addEventListener('astro:page-load', () => {
    initializeGalleries();
  });

  function initializeGalleries() {
    // Initialize all before/after sliders
    document.querySelectorAll('.gallery-comparison').forEach(initBeforeAfterSlider);

    // Initialize all carousels
    document.querySelectorAll('.gallery-carousel').forEach(initCarousel);
  }

  /**
   * Before/After Slider
   */
  function initBeforeAfterSlider(container: Element) {
    const beforeContainer = container.querySelector('[data-before-container]') as HTMLElement;
    const slider = container.querySelector('[data-slider]') as HTMLElement;

    if (!beforeContainer || !slider) return;

    let isDragging = false;

    function updateSliderPosition(clientX: number) {
      const rect = container.getBoundingClientRect();
      let percentage = ((clientX - rect.left) / rect.width) * 100;
      percentage = Math.max(0, Math.min(100, percentage));

      beforeContainer.style.clipPath = `inset(0 ${100 - percentage}% 0 0)`;
      slider.style.left = `${percentage}%`;
    }

    // Mouse events
    slider.addEventListener('mousedown', (e) => {
      isDragging = true;
      e.preventDefault();
    });

    container.addEventListener('mousedown', (e) => {
      isDragging = true;
      updateSliderPosition((e as MouseEvent).clientX);
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      updateSliderPosition(e.clientX);
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Touch events
    slider.addEventListener('touchstart', (e) => {
      isDragging = true;
      e.preventDefault();
    });

    container.addEventListener('touchstart', (e) => {
      isDragging = true;
      updateSliderPosition((e as TouchEvent).touches[0].clientX);
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      updateSliderPosition((e as TouchEvent).touches[0].clientX);
    });

    document.addEventListener('touchend', () => {
      isDragging = false;
    });
  }

  /**
   * Carousel Navigation
   */
  function initCarousel(carousel: Element) {
    const id = carousel.id;
    const track = carousel.querySelector('.gallery-track') as HTMLElement;
    const cards = Array.from(carousel.querySelectorAll('.gallery-card'));
    const prevBtn = document.querySelector(`[data-gallery-prev="${id}"]`) as HTMLButtonElement;
    const nextBtn = document.querySelector(`[data-gallery-next="${id}"]`) as HTMLButtonElement;
    const dots = Array.from(document.querySelectorAll(`[data-gallery-dot="${id}"]`));

    if (!track || cards.length === 0) return;

    let currentIndex = 0;
    let visibleCards = getVisibleCards();

    function getVisibleCards(): number {
      const width = window.innerWidth;
      if (width < 640) return 1;
      if (width < 1024) return 2;
      return 3;
    }

    function getMaxIndex(): number {
      return Math.max(0, cards.length - visibleCards);
    }

    function updateCarousel(animate = true) {
      const cardWidth = cards[0].getBoundingClientRect().width;
      const gap = parseFloat(getComputedStyle(track).gap) || 24;
      const offset = currentIndex * (cardWidth + gap);

      track.style.transition = animate ? '' : 'none';
      track.style.transform = `translateX(-${offset}px)`;

      // Update buttons
      if (prevBtn) {
        prevBtn.disabled = currentIndex === 0;
      }
      if (nextBtn) {
        nextBtn.disabled = currentIndex >= getMaxIndex();
      }

      // Update dots
      dots.forEach((dot, index) => {
        dot.classList.toggle('gallery-dot-active', index === currentIndex);
        dot.setAttribute('aria-selected', index === currentIndex ? 'true' : 'false');
      });
    }

    function goTo(index: number) {
      currentIndex = Math.max(0, Math.min(index, getMaxIndex()));
      updateCarousel();
    }

    // Navigation buttons
    prevBtn?.addEventListener('click', () => goTo(currentIndex - 1));
    nextBtn?.addEventListener('click', () => goTo(currentIndex + 1));

    // Dots
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => goTo(index));
    });

    // Touch swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    carousel.addEventListener('touchstart', (e) => {
      touchStartX = (e as TouchEvent).touches[0].clientX;
    });

    carousel.addEventListener('touchend', (e) => {
      touchEndX = (e as TouchEvent).changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          goTo(currentIndex + 1);
        } else {
          goTo(currentIndex - 1);
        }
      }
    });

    // Handle resize
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const newVisible = getVisibleCards();
        if (newVisible !== visibleCards) {
          visibleCards = newVisible;
          currentIndex = Math.min(currentIndex, getMaxIndex());
          updateCarousel(false);
        }
      }, 100);
    });

    // Initial setup
    updateCarousel(false);
  }
</script>
