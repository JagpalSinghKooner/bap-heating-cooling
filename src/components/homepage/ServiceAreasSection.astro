---
/**
 * Service Areas Section - Compact Professional Redesign
 * Two-column layout: Google Map (left) + Region Accordions (right)
 * Features: Single Card with dividers, compact spacing, consistent width
 */

import { getBusinessProfile } from '../../lib/getBusinessProfile';
import Section from '../primitives/Section.astro';

const profile = await getBusinessProfile();

// Helper: Convert region name to slug
function regionNameToSlug(name: string): string {
  return name.toLowerCase()
    .replace(/&/g, 'and')
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9-]/g, '');
}

// Sort regions alphabetically and add slugs
const sortedRegions = [...profile.coverage.regions]
  .map((region) => ({
    ...region,
    slug: regionNameToSlug(region.name),
    // Sort cities alphabetically within each region
    locations: [...region.locations].sort((a, b) => a.name.localeCompare(b.name))
  }))
  .sort((a, b) => a.name.localeCompare(b.name));

// Google Maps embed URL for B.A.P primary office
const mapEmbedUrl = 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2891.316800049599!2d-80.22174742382819!3d43.558281471106866!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x882b9a44d6b82ced%3A0x50e4c57c452cca9!2sB.A.P%20Heating%20%26%20Cooling%20Services%20Ltd!5e0!3m2!1sen!2suk!4v1768235065075!5m2!1sen!2suk';
---

<Section variant="muted">
  <!-- Section Header -->
  <div class="mb-10 text-center sm:mb-12">
    <p class="eyebrow mb-3">Fast Response Across Ontario</p>
    <h2 class="section-title">We Service Your Area</h2>
    <p class="section-description mx-auto max-w-2xl">
      Professional HVAC service across the Greater Toronto and Waterloo regions. Same-day service in most areas â€” local technicians, not dispatched from out of town.
    </p>
    <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm font-semibold text-primary">
      <div class="flex items-center gap-2">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Same-day service in most areas</span>
      </div>
      <div class="flex items-center gap-2">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span>Local technicians based in your community</span>
      </div>
    </div>
  </div>

  <!-- Two-Column Layout: Map + Accordions -->
  <div class="mt-8 grid grid-cols-1 gap-6 lg:mt-10 lg:grid-cols-2 lg:gap-8">

      <!-- LEFT: Google Map -->
      <div class="order-2 lg:order-1">
        <div class="card-standard overflow-hidden p-0 h-[320px] lg:h-full">
          <iframe
            src={mapEmbedUrl}
            width="100%"
            height="100%"
            style="border:0;"
            allowfullscreen=""
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            title="B.A.P Heating & Cooling Services Location Map"
            class="h-full w-full"
          ></iframe>
        </div>
        <p class="mt-3 text-center text-sm text-muted-foreground">
          <strong>Main Office:</strong> {profile.locations.primary.address_full}
        </p>
      </div>

      <!-- RIGHT: Region Accordions -->
      <div class="order-1 lg:order-2">
        <div class="card-standard overflow-hidden p-0" id="service-area-accordion">
          {sortedRegions.map((region, index) => (
            <div
              class={index > 0 ? 'border-t border-border' : ''}
              data-accordion-item
            >
              {/* Region Header (Clickable) */}
              <button
                type="button"
                class="accordion-trigger flex w-full items-center justify-between gap-4 px-5 py-3.5 text-left transition-colors hover:bg-muted/30"
                aria-expanded={index === 0 ? "true" : "false"}
                aria-controls={`region-${region.slug}`}
              >
                <div class="flex-1 min-w-0">
                  <h3 class="text-base font-semibold text-foreground">{region.name}</h3>
                </div>

                {/* Chevron Icon */}
                <svg
                  class="accordion-chevron h-5 w-5 flex-shrink-0 text-muted-foreground transition-transform duration-200"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              {/* Town List (Collapsible) */}
              <div
                id={`region-${region.slug}`}
                class="accordion-content"
                style={index === 0 ? '' : 'display: none;'}
              >
                <div class="border-t border-border px-5 py-3">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1.5">
                    {region.locations.map((location) => (
                      <a
                        href={`/locations/${location.slug}/`}
                        class="text-sm text-foreground hover:text-primary transition-colors py-1 flex items-center gap-2 group"
                        data-cta-context="service-areas-city"
                        data-city-name={location.name}
                        data-region-name={region.name}
                      >
                        <svg class="h-3 w-3 flex-shrink-0 text-muted-foreground group-hover:text-primary transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        <span>{location.name}</span>
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>

  <!-- Inline CTA -->
  <div class="mt-8 text-center">
    <a
      href={`tel:${profile.contact.phone_e164}`}
      class="inline-flex items-center gap-2 text-base font-semibold text-primary hover:underline"
      data-cta-context="service-areas-phone"
    >
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
      </svg>
      <span>Check service availability in your area: {profile.contact.phone_display}</span>
    </a>
  </div>
</Section>

<script>
  // Accordion behavior: Single-open accordion
  document.addEventListener('DOMContentLoaded', () => {
    const accordion = document.getElementById('service-area-accordion');
    if (!accordion) return;

    const triggers = accordion.querySelectorAll('.accordion-trigger');

    triggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const currentItem = trigger.closest('[data-accordion-item]');
        const currentContent = currentItem?.querySelector('.accordion-content') as HTMLElement | null;
        const currentChevron = trigger.querySelector('.accordion-chevron') as HTMLElement | null;
        const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

        // Close all other accordions
        triggers.forEach((otherTrigger) => {
          if (otherTrigger !== trigger) {
            const otherItem = otherTrigger.closest('[data-accordion-item]');
            const otherContent = otherItem?.querySelector('.accordion-content') as HTMLElement | null;
            const otherChevron = otherTrigger.querySelector('.accordion-chevron') as HTMLElement | null;

            otherTrigger.setAttribute('aria-expanded', 'false');
            if (otherContent) otherContent.style.display = 'none';
            if (otherChevron) otherChevron.style.transform = 'rotate(0deg)';
          }
        });

        // Toggle current accordion
        if (isExpanded) {
          trigger.setAttribute('aria-expanded', 'false');
          if (currentContent) currentContent.style.display = 'none';
          if (currentChevron) currentChevron.style.transform = 'rotate(0deg)';
        } else {
          trigger.setAttribute('aria-expanded', 'true');
          if (currentContent) currentContent.style.display = 'block';
          if (currentChevron) currentChevron.style.transform = 'rotate(180deg)';
        }
      });
    });

    // Initialize first accordion as open
    const firstTrigger = triggers[0] as HTMLElement;
    const firstChevron = firstTrigger?.querySelector('.accordion-chevron') as HTMLElement | null;
    if (firstChevron) {
      firstChevron.style.transform = 'rotate(180deg)';
    }
  });
</script>

<style>
  .accordion-trigger {
    cursor: pointer;
    background: transparent;
    border: none;
  }

  .accordion-chevron {
    transition: transform 0.2s ease-in-out;
  }
</style>
