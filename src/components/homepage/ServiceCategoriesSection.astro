---
/**
 * Service Categories Section
 * 6 service category cards in a 3-column grid
 * Heating, Cooling, Indoor Air Quality, Water Heating, Commercial, Emergency
 *
 * Variants:
 * - Homepage: Links to base service pages (/services/furnace-installation/)
 * - Service pages with locationSlug: Links to service-city pages (/services/furnace-installation-bolton-on/)
 */

import Section from '../primitives/Section.astro';
import { getBusinessProfile } from '../../lib/getBusinessProfile';

interface Props {
  locationSlug?: string;
  locationTitle?: string;
  currentServiceSlug?: string;
  variant?: 'default' | 'compact';
  title?: string;
  subtitle?: string;
}

const {
  locationSlug,
  locationTitle,
  currentServiceSlug,
  variant = 'default',
  title: customTitle,
  subtitle: customSubtitle,
} = Astro.props;

const profile = await getBusinessProfile();

// Helper to build service href based on location context
const buildServiceHref = (baseHref: string): string => {
  if (!locationSlug) return baseHref;

  // Extract service slug from base href (e.g., '/services/furnace-installation/' -> 'furnace-installation')
  const match = baseHref.match(/\/services\/([^/]+)\/?$/);
  if (!match) return baseHref;

  const serviceSlug = match[1];
  return `/services/${serviceSlug}-${locationSlug}-on/`;
};

type ServiceCard = {
  id: string;
  title: string;
  image: string;
  href: string;
  services: Array<{ title: string; href: string }>;
  isEmergency?: boolean;
};

const serviceCardsBase: ServiceCard[] = [
  {
    id: 'heating',
    title: 'Heating',
    image: '/images/services/furnace-installation.jpg',
    href: '/services/heating/',
    services: [
      { title: 'Furnace Installation', href: '/services/furnace-installation/' },
      { title: 'Furnace Repair', href: '/services/furnace-repair/' },
      { title: 'Heat Pump Installation', href: '/services/heat-pump-installation/' },
      { title: 'Heat Pump Repair', href: '/services/heat-pump-repair/' },
      { title: 'Boiler Installation', href: '/services/boiler-installation/' },
    ],
  },
  {
    id: 'cooling',
    title: 'Cooling',
    image: '/images/services/ac-unit-maintenance.jpg',
    href: '/services/cooling/',
    services: [
      { title: 'AC Installation', href: '/services/air-conditioner-installation/' },
      { title: 'AC Repair', href: '/services/air-conditioner-repair/' },
      { title: 'AC Maintenance', href: '/services/air-conditioner-maintenance/' },
      { title: 'Ductless Mini-Split', href: '/services/ductless-mini-split/' },
    ],
  },
  {
    id: 'indoor-air-quality',
    title: 'Indoor Air Quality',
    image: '/images/services/indoor-air-quality.jpg',
    href: '/services/indoor-air-quality/',
    services: [
      { title: 'Air Purifiers & Filtration', href: '/services/air-filtration-air-purifiers/' },
      { title: 'HRV/ERV Ventilation', href: '/services/hrv-erv-ventilation/' },
      { title: 'Humidifiers', href: '/services/humidifiers/' },
      { title: 'Dehumidifiers', href: '/services/dehumidifiers/' },
    ],
  },
  {
    id: 'water-heating',
    title: 'Water Heating',
    image: '/images/services/furnace-installation.jpg',
    href: '/services/water-heating/',
    services: [
      { title: 'Tank Water Heaters', href: '/services/tank-water-heaters/' },
      { title: 'Tankless Water Heaters', href: '/services/tankless-water-heaters/' },
    ],
  },
  {
    id: 'commercial',
    title: 'Commercial',
    image: '/images/services/hvac-repair-rooftop.jpg',
    href: '/services/commercial/',
    services: [
      { title: 'Commercial HVAC', href: '/services/commercial-hvac/' },
      { title: 'Rooftop Units', href: '/services/rooftop-units/' },
      { title: 'Maintenance Plans', href: '/services/maintenance-plans/' },
    ],
  },
  {
    id: 'emergency',
    title: '24/7 Emergency',
    image: '/images/services/ac-unit-maintenance.jpg',
    href: `tel:${profile.contact.phone_e164}`,
    isEmergency: true,
    services: [
      { title: 'Furnace Repair', href: '/services/furnace-repair/' },
      { title: 'AC Repair', href: '/services/air-conditioner-repair/' },
      { title: 'Heat Pump Repair', href: '/services/heat-pump-repair/' },
      { title: 'Boiler Repair', href: '/services/boiler-repair/' },
    ],
  },
];

// Transform service cards with location-aware hrefs
const serviceCards = serviceCardsBase.map((card) => ({
  ...card,
  href: card.isEmergency ? card.href : buildServiceHref(card.href),
  services: card.services.map((service) => ({
    ...service,
    href: buildServiceHref(service.href),
  })),
}));

// Context-aware section title and subtitle
const sectionTitle = customTitle || (locationTitle
  ? `HVAC Services in ${locationTitle}`
  : 'Our Services');

const sectionSubtitle = customSubtitle || (locationTitle
  ? `Professional heating, cooling, and air quality services throughout ${locationTitle}.`
  : 'Over 30 years serving homeowners and businesses across Guelph and surrounding areas.');

const sectionEyebrow = locationTitle ? `Services in ${locationTitle}` : 'What We Do';
---

<Section variant="default">
  <!-- Section Header -->
  <div class="mb-10 text-center sm:mb-12">
    <p class="eyebrow mb-3">{sectionEyebrow}</p>
    <h2 class="section-title mx-auto mb-4 max-w-3xl">{sectionTitle}</h2>
    <p class="mx-auto max-w-2xl text-base leading-relaxed text-muted-foreground">
      {sectionSubtitle}
    </p>
  </div>

  <!-- Service Cards Grid - 3 columns -->
  <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {serviceCards.map((card) => (
      <div
        class={`group flex h-full flex-col overflow-hidden rounded-2xl border transition-all duration-300 hover:shadow-lg ${card.isEmergency ? 'border-brand-orange bg-gradient-to-br from-brand-orange/5 to-brand-orange/10' : 'border-border bg-background'}`}
        data-service-id={card.id}
      >
        <!-- Image -->
        <div class="aspect-[16/10] w-full overflow-hidden">
          <img
            src={card.image}
            alt={card.title}
            class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
          />
        </div>

        <!-- Content -->
        <div class="flex flex-1 flex-col p-5">
          <!-- Title -->
          <h2 class={`mb-4 text-xl font-bold ${card.isEmergency ? 'text-brand-orange' : 'text-foreground'}`}>
            {card.title}
          </h2>

          <!-- Service Links -->
          <ul class="mb-4 flex-1 space-y-2">
            {card.services.map((service) => (
              <li>
                <a
                  href={service.href}
                  class="group/link flex items-center gap-2 text-sm text-muted-foreground transition-colors hover:text-foreground"
                >
                  <svg class={`h-4 w-4 flex-shrink-0 transition-transform group-hover/link:translate-x-0.5 ${card.isEmergency ? 'text-brand-orange' : 'text-primary'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  <span>{service.title}</span>
                </a>
              </li>
            ))}
          </ul>

          <!-- CTA Link -->
          {card.isEmergency ? (
            <a
              href={card.href}
              class="mt-auto inline-flex items-center justify-center gap-2 rounded-lg bg-brand-orange px-4 py-3 font-semibold text-white transition-all hover:bg-brand-orange-dark"
              data-cta-context={`service-card-${card.id}`}
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              <span>Call {profile.contact.phone_display}</span>
            </a>
          ) : (
            <a
              href={card.href}
              class="mt-auto inline-flex items-center gap-2 text-sm font-semibold text-primary transition-colors hover:text-primary/80"
              data-cta-context={`service-card-${card.id}`}
            >
              <span>View all {card.title.toLowerCase()} services</span>
              <svg class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </a>
          )}
        </div>
      </div>
    ))}
  </div>
</Section>
