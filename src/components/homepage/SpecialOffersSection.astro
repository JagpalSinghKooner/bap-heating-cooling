---
/**
 * Special Offers Section
 * Displays limited-time promotions to create urgency and drive conversions
 * Features: seasonal offers, first-time customer discounts, referral bonuses
 */

import { getBusinessProfile } from '../../lib/getBusinessProfile';

const profile = await getBusinessProfile();

type IconType = 'flame' | 'tag' | 'users';

// Define special offers (in a real app, these would come from CMS or database)
const offers: Array<{
  id: string;
  badge: string;
  title: string;
  description: string;
  savings: string;
  expires: string;
  cta: string;
  icon: IconType;
  featured: boolean;
}> = [
  {
    id: 'seasonal-tune-up',
    badge: 'Winter Special',
    title: '$99 Furnace Tune-Up',
    description: 'Complete furnace inspection and tune-up. Keep your home warm all winter.',
    savings: 'Save $50',
    expires: '2026-02-28',
    cta: 'Book Now',
    icon: 'flame',
    featured: true,
  },
  {
    id: 'first-time',
    badge: 'New Customer',
    title: '10% Off First Service',
    description: 'First-time customers receive 10% off any HVAC service or repair.',
    savings: 'Up to $100 Off',
    expires: '2026-12-31',
    cta: 'Claim Offer',
    icon: 'tag',
    featured: false,
  },
  {
    id: 'referral',
    badge: 'Referral Bonus',
    title: '$50 Referral Credit',
    description: 'Refer a friend and both get $50 off your next service when they book.',
    savings: 'Both Get $50',
    expires: 'Ongoing',
    cta: 'Refer Now',
    icon: 'users',
    featured: false,
  },
];

// Icons
const icons: Record<IconType, string> = {
  flame: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" /></svg>`,
  tag: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>`,
  users: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
};
---

<section class="bg-gradient-to-br from-brand-orange via-brand-orange to-brand-orange-dark py-12 sm:py-16 lg:py-20">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="mb-10 text-center text-white sm:mb-12">
      <div class="mb-3 inline-flex items-center gap-2 rounded-full bg-white/20 px-4 py-2 text-xs font-bold uppercase tracking-wide backdrop-blur-sm">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Limited Time Offers</span>
      </div>
      <h2 class="mb-3 text-3xl font-extrabold sm:text-4xl lg:text-5xl">
        Save Big on HVAC Services
      </h2>
      <p class="mx-auto max-w-2xl text-lg text-white/90 sm:text-xl">
        Exclusive deals to help you stay comfortable year-round without breaking the bank
      </p>
    </div>

    <!-- Offers Grid -->
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {offers.map((offer) => (
        <div
          class={`group relative overflow-hidden rounded-2xl border-2 backdrop-blur-sm transition-all duration-300 hover:scale-105 hover:shadow-2xl ${
            offer.featured
              ? 'border-white bg-white text-gray-900'
              : 'border-white/30 bg-white/10 text-white hover:border-white/50 hover:bg-white/20'
          }`}
          data-offer-id={offer.id}
        >
          {/* Featured Badge */}
          {offer.featured && (
            <div class="absolute right-4 top-4 rotate-12">
              <span class="inline-flex items-center gap-1 rounded-full bg-gradient-to-r from-brand-orange to-brand-orange-dark px-3 py-1 text-xs font-bold uppercase tracking-wide text-white shadow-lg">
                <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                Featured
              </span>
            </div>
          )}

          <div class="p-6 sm:p-8">
            {/* Icon */}
            <div class={`mb-4 inline-flex h-14 w-14 items-center justify-center rounded-2xl ${
              offer.featured ? 'bg-brand-orange/10 text-brand-orange' : 'bg-white/20 text-white'
            }`}>
              <span class="h-8 w-8" set:html={icons[offer.icon]} />
            </div>

            {/* Badge */}
            <div class="mb-3">
              <span class={`inline-block rounded-full px-3 py-1 text-xs font-bold uppercase tracking-wide ${
                offer.featured ? 'bg-brand-orange/10 text-brand-orange' : 'bg-white/20 text-white'
              }`}>
                {offer.badge}
              </span>
            </div>

            {/* Title */}
            <h3 class="mb-2 text-2xl font-bold sm:text-3xl">
              {offer.title}
            </h3>

            {/* Description */}
            <p class={`mb-4 text-sm leading-relaxed ${
              offer.featured ? 'text-gray-600' : 'text-white/80'
            }`}>
              {offer.description}
            </p>

            {/* Savings Badge */}
            <div class="mb-4 inline-flex items-center gap-2 rounded-lg bg-green-500/20 px-3 py-2">
              <svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class={`text-sm font-bold ${offer.featured ? 'text-green-700' : 'text-green-300'}`}>
                {offer.savings}
              </span>
            </div>

            {/* Expiry with Countdown */}
            {offer.expires !== 'Ongoing' && (
              <div class="mb-5 flex items-center gap-2 text-xs">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class={`font-semibold ${offer.featured ? 'text-gray-600' : 'text-white/80'}`}>
                  Expires: <span class="font-bold countdown-text" data-expires={offer.expires}>{offer.expires}</span>
                </span>
              </div>
            )}

            {/* CTA Button */}
            <a
              href={profile.contact.booking.url}
              target="_blank"
              rel="noopener noreferrer"
              class={`inline-flex w-full items-center justify-center gap-2 rounded-xl px-6 py-3 text-sm font-bold transition-all ${
                offer.featured
                  ? 'bg-brand-orange text-white shadow-lg hover:bg-brand-orange-dark hover:shadow-xl'
                  : 'bg-white text-brand-orange shadow-lg hover:bg-white/90 hover:shadow-xl'
              }`}
              data-cta-context={`special-offer-${offer.id}`}
            >
              <span>{offer.cta}</span>
              <svg class="h-5 w-5 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </a>
          </div>
        </div>
      ))}
    </div>

    <!-- Terms & Conditions -->
    <div class="mt-8 text-center text-xs text-white/70 sm:mt-10">
      <p>*Terms and conditions apply. Cannot be combined with other offers. New customers only where specified.</p>
    </div>
  </div>
</section>

<script>
  // Format expiry dates with countdown
  function initOfferCountdowns() {
    const countdownEls = document.querySelectorAll('.countdown-text');

    countdownEls.forEach((el) => {
      const expiresStr = el.getAttribute('data-expires');
      if (!expiresStr) return;

      const expiresDate = new Date(expiresStr).getTime();
      const now = new Date().getTime();
      const diffTime = expiresDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays > 0) {
        if (diffDays === 1) {
          el.textContent = 'Tomorrow!';
          el.classList.add('text-red-500', 'animate-pulse');
        } else if (diffDays <= 7) {
          el.textContent = `${diffDays} days left`;
          el.classList.add('text-red-500');
        } else {
          el.textContent = `${diffDays} days left`;
        }
      } else {
        el.textContent = 'Expired';
        const offerCard = el.closest('[data-offer-id]') as HTMLElement | null;
        if (offerCard) {
          offerCard.style.opacity = '0.6';
          offerCard.style.pointerEvents = 'none';
        }
      }
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initOfferCountdowns);
  } else {
    initOfferCountdowns();
  }
</script>
