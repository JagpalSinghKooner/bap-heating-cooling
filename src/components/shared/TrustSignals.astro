---
/**
 * TrustSignals Component
 *
 * Displays key trust indicators that build credibility and confidence.
 * Pulls data from the business profile for authentic, always-accurate information.
 *
 * Design Philosophy:
 * Trust signals should feel like earned credentials - professional certification
 * marks, not marketing fluff. Subtle industrial styling reinforces the "expert
 * tradesperson" positioning.
 *
 * Variants:
 * - horizontal: Inline row for headers, hero sections, compact spaces
 * - vertical:   Stacked list for sidebars, detailed trust sections
 * - compact:    Minimal with icons only, for tight spaces
 *
 * @example
 * <TrustSignals variant="horizontal" />
 * <TrustSignals variant="vertical" showRating showYears showLicense />
 * <TrustSignals variant="compact" showEmergency />
 */

import { getBusinessProfile } from '../../lib/getBusinessProfile';
import Icon from '../primitives/Icon.astro';

interface Props {
  /** Layout variant */
  variant?: 'horizontal' | 'vertical' | 'compact';
  /** Show Google rating with stars */
  showRating?: boolean;
  /** Show total review count */
  showReviewCount?: boolean;
  /** Show years in business */
  showYears?: boolean;
  /** Show TSSA license badge */
  showLicense?: boolean;
  /** Show 24/7 emergency indicator */
  showEmergency?: boolean;
  /** Theme for dark backgrounds */
  inverse?: boolean;
  /** Additional CSS classes */
  class?: string;
}

const {
  variant = 'horizontal',
  showRating = true,
  showReviewCount = true,
  showYears = true,
  showLicense = true,
  showEmergency = false,
  inverse = false,
  class: className = '',
} = Astro.props;

// Fetch business profile data
const profile = await getBusinessProfile();

// Calculate years in business
const currentYear = new Date().getFullYear();
const yearsInBusiness = currentYear - profile.business.established_year;

// Extract trust data
const googleRating = profile.reputation.google_rating;
const reviewCount = profile.reputation.google_review_count;
const hasEmergency = profile.hours.emergency_service;
const tssaLicense = profile.trust_and_compliance?.licenses?.tssa?.numbers?.[0] || '';

// Build the signals array based on what to show
type Signal = {
  id: string;
  icon: string;
  label: string;
  value?: string;
  highlight?: boolean;
};

const signals: Signal[] = [];

if (showRating) {
  signals.push({
    id: 'rating',
    icon: 'star',
    label: 'Google Rating',
    value: googleRating.toString(),
    highlight: true,
  });
}

if (showReviewCount) {
  signals.push({
    id: 'reviews',
    icon: 'quote',
    label: 'Reviews',
    value: `${reviewCount}+`,
  });
}

if (showYears) {
  signals.push({
    id: 'years',
    icon: 'shield',
    label: 'Years Experience',
    value: `${yearsInBusiness}+`,
  });
}

if (showLicense && tssaLicense) {
  signals.push({
    id: 'license',
    icon: 'certificate',
    label: 'TSSA Licensed',
  });
}

if (showEmergency && hasEmergency) {
  signals.push({
    id: 'emergency',
    icon: 'clock',
    label: '24/7 Service',
    highlight: true,
  });
}

// Variant class mapping
const variantClasses: Record<string, string> = {
  horizontal: 'trust-signals--horizontal',
  vertical:   'trust-signals--vertical',
  compact:    'trust-signals--compact',
};

const classes = [
  'trust-signals',
  variantClasses[variant],
  inverse ? 'trust-signals--inverse' : '',
  className,
].filter(Boolean).join(' ');
---

<div class={classes}>
  {signals.map((signal, index) => (
    <div
      class:list={[
        'trust-signal',
        signal.highlight && 'trust-signal--highlight',
      ]}
      style={`--signal-index: ${index}`}
    >
      {/* Icon container with industrial accent */}
      <div class="trust-signal__icon-wrap">
        <Icon
          name={signal.icon}
          size={variant === 'compact' ? 'md' : 'lg'}
          color={signal.id === 'rating' ? 'accent' : inverse ? 'inverse' : 'primary'}
        />
        {/* Star rating visual for rating signal */}
        {signal.id === 'rating' && variant !== 'compact' && (
          <div class="trust-signal__stars" aria-hidden="true">
            {[1, 2, 3, 4, 5].map((star) => (
              <span
                class:list={[
                  'star',
                  star <= Math.floor(googleRating) ? 'star--filled' : '',
                  star === Math.ceil(googleRating) && googleRating % 1 > 0 ? 'star--partial' : '',
                ]}
              >
                <Icon name="star" size="xs" />
              </span>
            ))}
          </div>
        )}
      </div>

      {/* Content */}
      {variant !== 'compact' && (
        <div class="trust-signal__content">
          {signal.value && (
            <span class="trust-signal__value">{signal.value}</span>
          )}
          <span class="trust-signal__label">{signal.label}</span>
        </div>
      )}

      {/* Tooltip for compact variant */}
      {variant === 'compact' && (
        <span class="trust-signal__tooltip">
          {signal.value ? `${signal.value} ${signal.label}` : signal.label}
        </span>
      )}
    </div>
  ))}
</div>

<style>
  /**
   * TrustSignals Styles
   * Industrial-modern trust indicators with subtle animated accents
   */

  /* ================================================================
     BASE CONTAINER
     ================================================================ */

  .trust-signals {
    display: flex;
    gap: var(--space-6);
  }

  /* ================================================================
     LAYOUT VARIANTS
     ================================================================ */

  /* Horizontal: Inline row */
  .trust-signals--horizontal {
    flex-direction: row;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-start;
  }

  /* Vertical: Stacked list */
  .trust-signals--vertical {
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Compact: Icons only in tight row */
  .trust-signals--compact {
    flex-direction: row;
    gap: var(--space-3);
  }

  /* ================================================================
     INDIVIDUAL SIGNAL
     ================================================================ */

  .trust-signal {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    position: relative;
  }

  /* Staggered animation on load */
  .trust-signal {
    opacity: 0;
    animation: trustSignalFadeIn var(--duration-slow) var(--ease-out) forwards;
    animation-delay: calc(var(--signal-index, 0) * 80ms);
  }

  @keyframes trustSignalFadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Horizontal variant: Add separator between items */
  .trust-signals--horizontal .trust-signal:not(:last-child)::after {
    content: '';
    position: absolute;
    right: calc(var(--space-3) * -1);
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 24px;
    background: linear-gradient(
      to bottom,
      transparent,
      var(--color-border-primary) 20%,
      var(--color-border-primary) 80%,
      transparent
    );
  }

  .trust-signals--inverse .trust-signal:not(:last-child)::after {
    background: linear-gradient(
      to bottom,
      transparent,
      rgba(255, 255, 255, 0.2) 20%,
      rgba(255, 255, 255, 0.2) 80%,
      transparent
    );
  }

  /* Vertical variant: Full-width with subtle background */
  .trust-signals--vertical .trust-signal {
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-surface-secondary);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--color-primary-200);
    transition:
      border-color var(--duration-fast) var(--ease-out),
      background-color var(--duration-fast) var(--ease-out);
  }

  .trust-signals--vertical .trust-signal:hover {
    border-left-color: var(--color-primary-500);
    background-color: var(--color-surface-tertiary);
  }

  .trust-signals--vertical .trust-signal--highlight {
    border-left-color: var(--color-accent-400);
    background-color: var(--color-accent-50);
  }

  .trust-signals--vertical .trust-signal--highlight:hover {
    border-left-color: var(--color-accent-500);
    background-color: var(--color-accent-100);
  }

  /* Compact variant: Just icons */
  .trust-signals--compact .trust-signal {
    padding: var(--space-2);
    background-color: var(--color-surface-tertiary);
    border-radius: var(--radius-md);
    cursor: default;
    transition:
      background-color var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
  }

  .trust-signals--compact .trust-signal:hover {
    background-color: var(--color-primary-50);
    transform: translateY(-2px);
  }

  .trust-signals--compact .trust-signal--highlight {
    background-color: var(--color-accent-50);
  }

  .trust-signals--compact .trust-signal--highlight:hover {
    background-color: var(--color-accent-100);
  }

  /* ================================================================
     ICON WRAPPER
     Industrial accent with subtle geometric details
     ================================================================ */

  .trust-signal__icon-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    position: relative;
  }

  /* ================================================================
     STAR RATING VISUAL
     ================================================================ */

  .trust-signal__stars {
    display: flex;
    gap: 1px;
  }

  .star {
    color: var(--color-border-primary);
    transition: color var(--duration-fast) var(--ease-out);
  }

  .star--filled {
    color: var(--color-accent-500);
  }

  .star--partial {
    color: var(--color-accent-300);
  }

  /* ================================================================
     CONTENT
     ================================================================ */

  .trust-signal__content {
    display: flex;
    flex-direction: column;
    gap: var(--space-0-5);
  }

  .trust-signal__value {
    font-family: var(--font-family-heading);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    line-height: var(--line-height-none);
    letter-spacing: var(--letter-spacing-tight);
  }

  .trust-signals--inverse .trust-signal__value {
    color: var(--color-text-inverse);
  }

  .trust-signal__label {
    font-family: var(--font-family-body);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-none);
    white-space: nowrap;
  }

  .trust-signals--inverse .trust-signal__label {
    color: rgba(255, 255, 255, 0.7);
  }

  /* Highlight variant value color */
  .trust-signal--highlight .trust-signal__value {
    color: var(--color-accent-700);
  }

  .trust-signals--inverse .trust-signal--highlight .trust-signal__value {
    color: var(--color-accent-400);
  }

  /* ================================================================
     TOOLTIP (for compact variant)
     ================================================================ */

  .trust-signal__tooltip {
    position: absolute;
    bottom: calc(100% + var(--space-2));
    left: 50%;
    transform: translateX(-50%);
    padding: var(--space-2) var(--space-3);
    background-color: var(--color-surface-inverse);
    color: var(--color-text-inverse);
    font-family: var(--font-family-body);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    white-space: nowrap;
    border-radius: var(--radius-md);
    opacity: 0;
    visibility: hidden;
    transition:
      opacity var(--duration-fast) var(--ease-out),
      visibility var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
    z-index: var(--z-tooltip);
    pointer-events: none;
  }

  /* Tooltip arrow */
  .trust-signal__tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: var(--color-surface-inverse);
  }

  /* Show tooltip on hover */
  .trust-signals--compact .trust-signal:hover .trust-signal__tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-4px);
  }

  /* ================================================================
     INVERSE THEME (for dark backgrounds)
     ================================================================ */

  .trust-signals--inverse .trust-signals--vertical .trust-signal {
    background-color: rgba(255, 255, 255, 0.08);
    border-left-color: rgba(255, 255, 255, 0.3);
  }

  .trust-signals--inverse .trust-signals--vertical .trust-signal:hover {
    background-color: rgba(255, 255, 255, 0.12);
    border-left-color: var(--color-primary-400);
  }

  .trust-signals--inverse .trust-signals--compact .trust-signal {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .trust-signals--inverse .trust-signals--compact .trust-signal:hover {
    background-color: rgba(255, 255, 255, 0.15);
  }

  /* ================================================================
     RESPONSIVE ADJUSTMENTS
     ================================================================ */

  @media (max-width: 768px) {
    .trust-signals--horizontal {
      gap: var(--space-4);
      justify-content: center;
    }

    /* Remove separators on mobile */
    .trust-signals--horizontal .trust-signal::after {
      display: none;
    }

    .trust-signal__value {
      font-size: var(--font-size-lg);
    }

    .trust-signal__label {
      font-size: var(--font-size-xs);
    }
  }

  /* Very small screens: Stack horizontally */
  @media (max-width: 480px) {
    .trust-signals--horizontal {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-3);
    }

    .trust-signals--horizontal .trust-signal {
      justify-content: flex-start;
      padding: var(--space-2) var(--space-3);
      background-color: var(--color-surface-secondary);
      border-radius: var(--radius-md);
    }
  }

  /* ================================================================
     REDUCED MOTION
     ================================================================ */

  @media (prefers-reduced-motion: reduce) {
    .trust-signal {
      opacity: 1;
      animation: none;
    }
  }
</style>
