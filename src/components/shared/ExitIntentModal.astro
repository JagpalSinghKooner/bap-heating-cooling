---
/**
 * ExitIntentModal Component
 *
 * A conversion-focused modal that appears when the user shows intent to leave.
 * Uses mouse movement detection (cursor moving toward browser close area).
 *
 * Features:
 * - Triggers on exit intent (cursor moving to top of viewport)
 * - Shows only once per session (localStorage)
 * - Delayed trigger (doesn't fire immediately on page load)
 * - Mobile-aware (uses different trigger on mobile)
 * - Conversion-optimized with phone CTA
 *
 * The Phone Number Rule: The phone number appears here as one of 8 key locations.
 */

import Modal from './Modal.astro';
import Button from '../primitives/Button.astro';
import { getBusinessProfile, getPhoneDisplay, getPhoneLink, getCompanyName } from '../../lib/getBusinessProfile';

interface Props {
  headline?: string;
  description?: string;
  ctaLabel?: string;
  ctaHref?: string;
  showPhone?: boolean;
  /** Minimum time on page before exit intent can trigger (ms) */
  minTimeOnPage?: number;
  /** Storage key for tracking if shown this session */
  storageKey?: string;
}

const profile = await getBusinessProfile();

const {
  headline = "Wait! Before You Go...",
  description = `Still have questions about your heating or cooling needs? Our friendly team at ${getCompanyName(profile)} is here to help. Get a free estimate with no obligation.`,
  ctaLabel = "Get Free Estimate",
  ctaHref = getPhoneLink(profile),
  showPhone = true,
  minTimeOnPage = 5000,
  storageKey = 'bap_exit_intent_shown',
} = Astro.props;

const phoneDisplay = getPhoneDisplay(profile);
const phoneLink = getPhoneLink(profile);
const isEmergencyAvailable = profile.hours.phone_answered_24_7;
const yearsInBusiness = new Date().getFullYear() - profile.business.established_year;
---

<div
  id="exit-intent-config"
  data-min-time={minTimeOnPage}
  data-storage-key={storageKey}
  hidden
></div>
<Modal
  id="exit-intent-modal"
  size="md"
  showCloseButton={true}
  class="exit-intent-modal"
>
  <div class="text-center">
    <!-- Icon - Phone ringing animation -->
    <div class="exit-intent-icon mx-auto mb-5 w-16 h-16 rounded-full bg-accent-100 flex items-center justify-center">
      <svg
        class="w-8 h-8 text-accent-600"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
        />
      </svg>
    </div>

    <!-- Headline -->
    <h3 class="text-2xl sm:text-3xl font-display font-semibold text-text-primary mb-3">
      {headline}
    </h3>

    <!-- Description -->
    <p class="text-text-secondary text-base sm:text-lg leading-relaxed mb-6 max-w-md mx-auto">
      {description}
    </p>

    <!-- Trust indicators -->
    <div class="flex flex-wrap items-center justify-center gap-4 mb-6 text-sm text-text-secondary">
      <span class="flex items-center gap-1.5">
        <svg class="w-4 h-4 text-success-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span>Free Estimates</span>
      </span>
      <span class="flex items-center gap-1.5">
        <svg class="w-4 h-4 text-success-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span>{yearsInBusiness}+ Years Experience</span>
      </span>
      {isEmergencyAvailable && (
        <span class="flex items-center gap-1.5">
          <svg class="w-4 h-4 text-success-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span>24/7 Available</span>
        </span>
      )}
    </div>

    <!-- CTA Stack -->
    <div class="space-y-3">
      <!-- Primary CTA - Call Button -->
      {showPhone && (
        <Button
          variant="primary"
          size="lg"
          href={phoneLink}
          iconLeft="phone"
          fullWidth
          data-cta-context="exit-intent-modal"
        >
          Call Now: {phoneDisplay}
        </Button>
      )}

      <!-- Secondary CTA - Custom action -->
      {(!showPhone || ctaHref !== phoneLink) && (
        <Button
          variant={showPhone ? 'secondary' : 'primary'}
          size="lg"
          href={ctaHref}
          fullWidth
          data-cta-context="exit-intent-modal-secondary"
        >
          {ctaLabel}
        </Button>
      )}

      <!-- Dismissive link -->
      <button
        type="button"
        class="text-sm text-text-tertiary hover:text-text-secondary transition-colors duration-fast"
        data-modal-close
      >
        No thanks, I'll continue browsing
      </button>
    </div>
  </div>

  <!-- Footer slot with guarantee message -->
  <div
    slot="footer"
    class="px-6 py-4 bg-surface-secondary border-t border-border text-center"
  >
    <p class="text-sm text-text-secondary">
      <strong class="text-text-primary">100% Satisfaction Guaranteed.</strong>
      {' '}No high-pressure sales, just honest advice from local experts.
    </p>
  </div>
</Modal>

<style>
  /* Icon animation */
  .exit-intent-icon {
    animation: gentle-pulse 2s ease-in-out infinite;
  }

  @keyframes gentle-pulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 0 0 8px rgba(249, 115, 22, 0);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .exit-intent-icon {
      animation: none;
    }
  }
</style>

<script is:inline>
  /**
   * Exit Intent Detection
   *
   * Triggers the modal when:
   * 1. User moves mouse toward top of viewport (exit intent on desktop)
   * 2. User attempts to leave via back button or tab close on mobile
   * 3. Minimum time on page has passed
   * 4. Modal hasn't been shown this session
   */

  class ExitIntentDetector {
    constructor() {
      // Read config from data attributes
      var configEl = document.getElementById('exit-intent-config');
      var minTimeOnPage = configEl ? parseInt(configEl.dataset.minTime || '5000', 10) : 5000;
      var storageKey = configEl ? configEl.dataset.storageKey || 'bap_exit_intent_shown' : 'bap_exit_intent_shown';

      this.modalId = 'exit-intent-modal';
      this.hasShown = false;
      this.canShow = false;
      this.minTime = minTimeOnPage;
      this.exitStorageKey = storageKey;
      this.init();
    }

    init() {
      // Check if already shown this session
      if (this.wasShownThisSession()) {
        return;
      }

      // Wait minimum time before enabling
      setTimeout(() => {
        this.canShow = true;
        this.attachListeners();
      }, this.minTime);
    }

    wasShownThisSession() {
      try {
        return sessionStorage.getItem(this.exitStorageKey) === 'true';
      } catch (e) {
        // sessionStorage not available
        return false;
      }
    }

    markAsShown() {
      try {
        sessionStorage.setItem(this.exitStorageKey, 'true');
      } catch (e) {
        // sessionStorage not available
      }
      this.hasShown = true;
    }

    attachListeners() {
      // Desktop: Mouse exit intent
      document.addEventListener('mouseout', this.handleMouseOut.bind(this));

      // Mobile: Back button / leaving page
      window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));

      // Track scroll depth for engagement scoring
      let maxScrollDepth = 0;
      window.addEventListener('scroll', () => {
        const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
        maxScrollDepth = Math.max(maxScrollDepth, scrollPercent);
      });

      // Listen for modal close to track
      const modal = document.getElementById(this.modalId);
      if (modal) {
        modal.addEventListener('modal:close', () => {
          // Could track conversion here
        });
      }
    }

    handleMouseOut(e) {
      if (!this.canShow || this.hasShown) return;

      // Only trigger if mouse is moving toward the top of the viewport
      // Simplified conditions - previous check was too strict and rarely triggered
      const shouldTrigger =
        e.clientY <= 10 && // Near top edge (relaxed from 5px)
        !e.relatedTarget; // Actually leaving the document

      if (shouldTrigger) {
        this.showModal();
      }
    }

    handleBeforeUnload(_e) {
      // On mobile, we can't really show a modal on beforeunload
      // This is here for future mobile-specific implementations
    }

    showModal() {
      if (this.hasShown) return;

      const modal = document.getElementById(this.modalId);
      if (modal) {
        modal.setAttribute('data-open', 'true');
        this.markAsShown();

        // Track the event (for analytics)
        if (typeof window !== 'undefined' && window.gtag) {
          window.gtag('event', 'exit_intent_shown', {
            event_category: 'engagement',
            event_label: 'exit_intent_modal',
          });
        }
      }
    }
  }

  // Initialize on page load
  function initExitIntent() {
    // Only initialize on client side
    if (typeof window !== 'undefined') {
      new ExitIntentDetector();
    }
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExitIntent);
  } else {
    initExitIntent();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initExitIntent);
</script>
