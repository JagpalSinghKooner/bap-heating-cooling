---
/**
 * FAQSection Component
 *
 * A complete FAQ section that combines:
 * - Section wrapper with proper background variant
 * - SectionHeader with eyebrow, headline, description
 * - Accordion with FAQ items
 * - Schema.org FAQPage structured data for SEO
 * - Optional CTA at the bottom
 *
 * "Trustworthy Industrial Modern" aesthetic:
 * - Clear hierarchy guides users to answers fast
 * - Professional layout builds confidence
 * - Schema markup shows rich results in Google
 * - Optional CTA captures users who don't find their answer
 *
 * Data Sources:
 * - FAQs come via faqResolver (scoped to page context)
 * - Can also accept direct FAQ array prop
 *
 * @example
 * <FAQSection
 *   faqs={[
 *     { question: "How long...", answer: "Most installations..." },
 *     { question: "Do you offer...", answer: "Yes, we provide..." }
 *   ]}
 *   title="Frequently Asked Questions"
 * />
 *
 * @example With CTA
 * <FAQSection
 *   faqs={faqs}
 *   showCTA={true}
 *   ctaHeadline="Still have questions?"
 *   ctaLabel="Call Us Now"
 *   ctaHref="tel:+15551234567"
 * />
 */

import Section from '../primitives/Section.astro';
import Container from '../primitives/Container.astro';
import SectionHeader from '../primitives/SectionHeader.astro';
import Button from '../primitives/Button.astro';
import Accordion from './Accordion.astro';
import AccordionItem from './AccordionItem.astro';

interface FAQ {
  question: string;
  answer: string;
}

interface Props {
  /** Array of FAQ objects */
  faqs: FAQ[];
  /** Section title (optional - defaults to "Frequently Asked Questions") */
  title?: string;
  /** Section description (optional) */
  description?: string;
  /** Eyebrow text above title */
  eyebrow?: string;
  /** Number of columns for FAQ grid (1 or 2) */
  columns?: 1 | 2;
  /** Whether to show a CTA at the bottom */
  showCTA?: boolean;
  /** CTA headline text */
  ctaHeadline?: string;
  /** CTA button label */
  ctaLabel?: string;
  /** CTA button link */
  ctaHref?: string;
  /** Section background variant */
  variant?: 'default' | 'muted' | 'warm';
  /** Accordion visual style */
  accordionVariant?: 'default' | 'bordered' | 'separated';
  /** Section padding size */
  padding?: 'sm' | 'md' | 'lg';
  /** Allow multiple FAQs open at once */
  allowMultiple?: boolean;
  /** Include Schema.org FAQPage structured data */
  includeSchema?: boolean;
  /** Section ID for anchor links */
  id?: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  faqs,
  title = 'Frequently Asked Questions',
  description,
  eyebrow = 'FAQ',
  columns = 1,
  showCTA = false,
  ctaHeadline = "Can't find your answer?",
  ctaLabel = 'Contact Us',
  ctaHref = '/contact-us/',
  variant = 'default',
  accordionVariant = 'default',
  padding = 'md',
  allowMultiple = true,
  includeSchema = true,
  id = 'faq',
  class: className = '',
} = Astro.props;

// Filter out empty FAQs
const validFaqs = faqs?.filter(faq => faq.question && faq.answer) || [];

// Split FAQs into columns if 2-column layout
const columnCount = columns === 2 && validFaqs.length > 2 ? 2 : 1;
const midpoint = Math.ceil(validFaqs.length / 2);
const leftColumn = columnCount === 2 ? validFaqs.slice(0, midpoint) : validFaqs;
const rightColumn = columnCount === 2 ? validFaqs.slice(midpoint) : [];

// Generate Schema.org FAQPage structured data
const faqSchema = includeSchema && validFaqs.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  'mainEntity': validFaqs.map(faq => ({
    '@type': 'Question',
    'name': faq.question,
    'acceptedAnswer': {
      '@type': 'Answer',
      'text': faq.answer,
    },
  })),
} : null;

// Section wrapper classes
const sectionClasses = [
  'faq-section',
  className,
].filter(Boolean).join(' ');
---

{validFaqs.length > 0 && (
  <Section
    variant={variant}
    padding={padding}
    id={id}
    class={sectionClasses}
  >
    <Container size="xl">
      {/* Section Header */}
      <div class="faq-section-header">
        <SectionHeader
          eyebrow={eyebrow}
          headline={title}
          description={description}
          align="center"
          headlineSize="lg"
        />
      </div>

      {/* FAQ Content */}
      <div class={`faq-section-content ${columnCount === 2 ? 'faq-columns' : ''}`}>
        {columnCount === 2 ? (
          <>
            {/* Two Column Layout */}
            <div class="faq-column">
              <Accordion variant={accordionVariant} allowMultiple={allowMultiple}>
                {leftColumn.map((faq) => (
                  <AccordionItem
                    question={faq.question}
                    answer={faq.answer}
                  />
                ))}
              </Accordion>
            </div>
            <div class="faq-column">
              <Accordion variant={accordionVariant} allowMultiple={allowMultiple}>
                {rightColumn.map((faq) => (
                  <AccordionItem
                    question={faq.question}
                    answer={faq.answer}
                  />
                ))}
              </Accordion>
            </div>
          </>
        ) : (
          <>
            {/* Single Column Layout */}
            <div class="faq-single-column">
              <Accordion variant={accordionVariant} allowMultiple={allowMultiple}>
                {validFaqs.map((faq) => (
                  <AccordionItem
                    question={faq.question}
                    answer={faq.answer}
                  />
                ))}
              </Accordion>
            </div>
          </>
        )}
      </div>

      {/* Optional CTA */}
      {showCTA && (
        <div class="faq-section-cta">
          <div class="faq-cta-content">
            <p class="faq-cta-headline">{ctaHeadline}</p>
            <Button
              variant="primary"
              size="lg"
              href={ctaHref}
            >
              {ctaLabel}
            </Button>
          </div>
        </div>
      )}
    </Container>

    {/* Schema.org Structured Data */}
    {faqSchema && (
      <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
    )}
  </Section>
)}

<style>
  /**
   * FAQSection Layout Styles
   *
   * Provides consistent spacing and responsive layout for FAQ content.
   */

  /* ================================================================
     SECTION HEADER - Spacing below header
     ================================================================ */

  .faq-section-header {
    margin-bottom: var(--space-12);
  }

  /* ================================================================
     CONTENT CONTAINER - Single or two column
     ================================================================ */

  .faq-section-content {
    max-width: var(--container-lg);
    margin: 0 auto;
  }

  /* Single column layout - constrained width for readability */
  .faq-single-column {
    max-width: var(--container-md);
    margin: 0 auto;
  }

  /* ================================================================
     TWO COLUMN LAYOUT - Side by side FAQs
     ================================================================ */

  .faq-columns {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-8);
    max-width: none;
  }

  @media (min-width: 1024px) {
    .faq-columns {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-12);
    }
  }

  .faq-column {
    /* Each column gets its own accordion */
  }

  /* ================================================================
     CTA BLOCK - Bottom call-to-action
     ================================================================ */

  .faq-section-cta {
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-border-primary);
  }

  .faq-cta-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-4);
  }

  .faq-cta-headline {
    font-family: var(--font-family-heading);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
  }

  /* ================================================================
     INVERSE CONTEXT - Dark section styling
     ================================================================ */

  .section-inverse .faq-section-cta {
    border-top-color: rgba(255, 255, 255, 0.15);
  }

  .section-inverse .faq-cta-headline {
    color: var(--color-text-inverse);
  }

  /* ================================================================
     RESPONSIVE ADJUSTMENTS
     ================================================================ */

  @media (max-width: 768px) {
    .faq-section-header {
      margin-bottom: var(--space-8);
    }

    .faq-section-cta {
      margin-top: var(--space-8);
      padding-top: var(--space-6);
    }

    .faq-cta-headline {
      font-size: var(--font-size-lg);
    }
  }

  /* ================================================================
     WARM VARIANT - Additional styling for trust sections
     ================================================================ */

  :global(.section-bg-warm) .faq-section-cta {
    border-top-color: var(--color-primary-100);
    background: linear-gradient(
      180deg,
      transparent 0%,
      var(--color-primary-50) 100%
    );
    margin-left: calc(-1 * var(--container-padding));
    margin-right: calc(-1 * var(--container-padding));
    padding-left: var(--container-padding);
    padding-right: var(--container-padding);
    padding-bottom: var(--space-8);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
  }
</style>
