---
/**
 * AccordionItem Component
 *
 * Individual expandable/collapsible item within an Accordion.
 * Uses native HTML <details>/<summary> elements for semantic correctness
 * and progressive enhancement.
 *
 * "Trustworthy Industrial Modern" aesthetic:
 * - Clear, confident typography for questions
 * - Smooth, professional expand/collapse animation
 * - Plus icon that rotates to X when open (industrial feel)
 * - Generous touch targets for mobile
 *
 * Animation Technique:
 * Uses CSS grid with grid-template-rows: 0fr / 1fr for smooth
 * height transitions without JavaScript calculations.
 *
 * @example
 * <AccordionItem
 *   question="How long does a furnace installation take?"
 *   answer="Most installations are completed in one day..."
 * />
 *
 * @example With slot content
 * <AccordionItem question="What brands do you service?">
 *   <p>We service all major brands including:</p>
 *   <ul>
 *     <li>Carrier</li>
 *     <li>Lennox</li>
 *   </ul>
 * </AccordionItem>
 */

import Icon from '../primitives/Icon.astro';

interface Props {
  /** The question/trigger text */
  question: string;
  /** The answer text (alternative to slot content) */
  answer?: string;
  /** Whether this item starts open */
  defaultOpen?: boolean;
  /** Visual variant (inherits from parent Accordion) */
  variant?: 'default' | 'highlighted';
  /** Icon style for the toggle indicator */
  iconStyle?: 'plus' | 'chevron';
  /** Additional CSS classes */
  class?: string;
  /** ID for the content panel (for aria-controls) */
  id?: string;
}

const {
  question,
  answer,
  defaultOpen = false,
  variant = 'default',
  iconStyle = 'plus',
  class: className = '',
  id,
} = Astro.props;

// Generate unique ID for accessibility if not provided
const contentId = id || `accordion-content-${Math.random().toString(36).slice(2, 9)}`;

// Determine if we have slot content or answer prop
const hasSlotContent = Astro.slots.has('default');

const itemClasses = [
  'accordion-item',
  `accordion-item-${variant}`,
  className,
].filter(Boolean).join(' ');
---

<details
  class={itemClasses}
  data-accordion-item
  open={defaultOpen}
>
  <summary class="accordion-item-trigger">
    <span class="accordion-item-question">{question}</span>
    <span class="accordion-item-icon" aria-hidden="true">
      {iconStyle === 'plus' ? (
        <span class="accordion-icon-plus">
          <span class="icon-bar icon-bar-h"></span>
          <span class="icon-bar icon-bar-v"></span>
        </span>
      ) : (
        <Icon name="chevron-down" size="md" />
      )}
    </span>
  </summary>

  <div class="accordion-item-body">
    <div class="accordion-item-content" id={contentId}>
      {hasSlotContent ? (
        <slot />
      ) : answer ? (
        <p class="accordion-item-answer">{answer}</p>
      ) : null}
    </div>
  </div>
</details>

<style>
  /**
   * AccordionItem Styles
   *
   * Uses CSS grid trick for smooth height animation:
   * - Outer container toggles grid-template-rows: 0fr / 1fr
   * - Inner container has overflow: hidden and min-height: 0
   * - Results in smooth expansion without knowing content height
   */

  .accordion-item {
    position: relative;
  }

  /* ================================================================
     TRIGGER - The clickable question header
     ================================================================ */

  .accordion-item-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    width: 100%;
    padding: var(--space-5) 0;
    cursor: pointer;
    list-style: none; /* Remove default marker */
    user-select: none;
    transition: color var(--duration-fast) var(--ease-default);
  }

  /* Remove default details marker in Safari */
  .accordion-item-trigger::-webkit-details-marker {
    display: none;
  }

  .accordion-item-trigger::marker {
    display: none;
    content: '';
  }

  /* Hover state */
  .accordion-item-trigger:hover {
    color: var(--color-primary-600);
  }

  /* Focus state */
  .accordion-item-trigger:focus {
    outline: none;
  }

  .accordion-item-trigger:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
  }

  /* ================================================================
     QUESTION TEXT - The trigger label
     ================================================================ */

  .accordion-item-question {
    font-family: var(--font-family-heading);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    line-height: var(--line-height-snug);
    color: var(--color-text-primary);
    text-align: left;
    flex: 1;
    transition: color var(--duration-fast) var(--ease-default);
  }

  .accordion-item[open] .accordion-item-question {
    color: var(--color-primary-700);
  }

  /* ================================================================
     ICON - Plus/X toggle indicator
     Industrial aesthetic with rotating bars
     ================================================================ */

  .accordion-item-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    color: var(--color-text-secondary);
    transition: color var(--duration-fast) var(--ease-default);
  }

  .accordion-item-trigger:hover .accordion-item-icon {
    color: var(--color-primary-600);
  }

  /* Plus icon - custom CSS implementation for smooth rotation */
  .accordion-icon-plus {
    position: relative;
    width: 1rem;
    height: 1rem;
  }

  .icon-bar {
    position: absolute;
    background-color: currentColor;
    border-radius: 2px;
    transition: transform var(--duration-normal) var(--ease-default);
  }

  .icon-bar-h {
    width: 100%;
    height: 2px;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
  }

  .icon-bar-v {
    width: 2px;
    height: 100%;
    left: 50%;
    top: 0;
    transform: translateX(-50%);
  }

  /* When open, rotate the vertical bar to form an X minus */
  .accordion-item[open] .icon-bar-v {
    transform: translateX(-50%) scaleY(0);
    opacity: 0;
  }

  /* Chevron rotation alternative */
  .accordion-item-icon :global(.icon) {
    transition: transform var(--duration-normal) var(--ease-default);
  }

  .accordion-item[open] .accordion-item-icon :global(.icon) {
    transform: rotate(180deg);
  }

  /* ================================================================
     BODY - Animated container using CSS grid trick
     ================================================================ */

  .accordion-item-body {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows var(--duration-slow) var(--ease-default);
  }

  .accordion-item[open] .accordion-item-body {
    grid-template-rows: 1fr;
  }

  /* ================================================================
     CONTENT - Inner content with overflow handling
     ================================================================ */

  .accordion-item-content {
    overflow: hidden;
    min-height: 0; /* Critical for grid animation to work */
  }

  /* Add padding when visible, animate with the grid */
  .accordion-item[open] .accordion-item-content {
    padding-bottom: var(--space-5);
  }

  /* ================================================================
     ANSWER TEXT - Default answer paragraph
     ================================================================ */

  .accordion-item-answer {
    font-family: var(--font-family-body);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Slot content styling */
  .accordion-item-content :global(p) {
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
  }

  .accordion-item-content :global(p:last-child) {
    margin-bottom: 0;
  }

  .accordion-item-content :global(ul),
  .accordion-item-content :global(ol) {
    margin: var(--space-3) 0;
    padding-left: var(--space-6);
    color: var(--color-text-secondary);
  }

  .accordion-item-content :global(ul) {
    list-style: disc;
  }

  .accordion-item-content :global(ol) {
    list-style: decimal;
  }

  .accordion-item-content :global(li) {
    margin-bottom: var(--space-2);
    line-height: var(--line-height-relaxed);
  }

  .accordion-item-content :global(a) {
    color: var(--color-text-link);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .accordion-item-content :global(a:hover) {
    color: var(--color-text-link-hover);
  }

  .accordion-item-content :global(strong) {
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
  }

  /* ================================================================
     VARIANT: Highlighted
     For featured or important items
     ================================================================ */

  .accordion-item-highlighted {
    background-color: var(--color-primary-50);
    border-left: 4px solid var(--color-primary-500);
    padding-left: var(--space-4);
    padding-right: var(--space-4);
    border-radius: var(--radius-md);
  }

  .accordion-item-highlighted .accordion-item-trigger {
    padding-left: 0;
    padding-right: 0;
  }

  /* ================================================================
     INVERSE CONTEXT
     When inside dark sections
     ================================================================ */

  .section-inverse .accordion-item-question {
    color: var(--color-text-inverse);
  }

  .section-inverse .accordion-item[open] .accordion-item-question {
    color: var(--color-primary-200);
  }

  .section-inverse .accordion-item-icon {
    color: var(--color-primary-300);
  }

  .section-inverse .accordion-item-answer,
  .section-inverse .accordion-item-content :global(p),
  .section-inverse .accordion-item-content :global(li) {
    color: rgba(255, 255, 255, 0.8);
  }

  .section-inverse .accordion-item-content :global(a) {
    color: var(--color-primary-300);
  }

  .section-inverse .accordion-item-content :global(strong) {
    color: var(--color-text-inverse);
  }

  /* ================================================================
     RESPONSIVE - Mobile adjustments
     ================================================================ */

  @media (max-width: 768px) {
    .accordion-item-trigger {
      padding: var(--space-4) 0;
      gap: var(--space-3);
    }

    .accordion-item-question {
      font-size: var(--font-size-base);
    }

    .accordion-item-icon {
      width: 1.75rem;
      height: 1.75rem;
    }

    .accordion-item[open] .accordion-item-content {
      padding-bottom: var(--space-4);
    }
  }

  /* ================================================================
     REDUCED MOTION - Respect user preferences
     ================================================================ */

  @media (prefers-reduced-motion: reduce) {
    .accordion-item-body {
      transition: none;
    }

    .icon-bar {
      transition: none;
    }

    .accordion-item-icon :global(.icon) {
      transition: none;
    }
  }
</style>
