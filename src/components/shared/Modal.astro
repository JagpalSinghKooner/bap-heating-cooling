---
/**
 * Modal Component
 *
 * A flexible, accessible modal dialog component.
 * Features:
 * - Focus trap (keyboard users stay within modal)
 * - Escape key to close
 * - Backdrop click to close
 * - Body scroll lock when open
 * - Smooth enter/exit animations
 * - Three sizes: sm, md, lg
 *
 * Usage:
 * <Modal id="my-modal" title="Modal Title">
 *   <p>Modal content here</p>
 * </Modal>
 *
 * To open: document.getElementById('my-modal')?.setAttribute('data-open', 'true')
 * To close: document.getElementById('my-modal')?.removeAttribute('data-open')
 */

interface Props {
  id: string;
  title?: string;
  size?: 'sm' | 'md' | 'lg';
  showCloseButton?: boolean;
  class?: string;
}

const {
  id,
  title,
  size = 'md',
  showCloseButton = true,
  class: className = '',
} = Astro.props;

// Size configurations
const sizeConfig = {
  sm: 'max-w-md',      // 448px
  md: 'max-w-xl',      // 576px
  lg: 'max-w-2xl',     // 672px
};
---

<!-- Modal Root - Hidden by default, shown via data-open attribute -->
<div
  id={id}
  class:list={[
    'modal-root',
    'fixed inset-0',
    'flex items-center justify-center',
    'p-4 sm:p-6',
    className,
  ]}
  role="dialog"
  aria-modal="true"
  aria-labelledby={title ? `${id}-title` : undefined}
  aria-hidden="true"
  data-modal
>
  <!-- Backdrop -->
  <div
    class="modal-backdrop absolute inset-0 bg-surface-inverse/60 backdrop-blur-sm"
    data-modal-backdrop
  />

  <!-- Modal Panel -->
  <div
    class:list={[
      'modal-panel',
      'relative w-full',
      sizeConfig[size],
      'bg-surface-primary',
      'rounded-xl',
      'shadow-2xl',
      'flex flex-col',
      'max-h-[calc(100vh-3rem)]',
      'overflow-hidden',
    ]}
    data-modal-panel
  >
    <!-- Header -->
    {(title || showCloseButton) && (
      <div class="modal-header flex items-center justify-between px-6 py-4 border-b border-border">
        {title && (
          <h2
            id={`${id}-title`}
            class="text-xl font-heading font-bold text-text-primary"
          >
            {title}
          </h2>
        )}
        {showCloseButton && (
          <button
            type="button"
            class:list={[
              'modal-close-btn',
              'flex items-center justify-center',
              'w-10 h-10 -mr-2',
              'rounded-lg',
              'text-text-secondary hover:text-text-primary',
              'hover:bg-surface-secondary',
              'transition-colors duration-fast',
              'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-border-focus focus-visible:ring-offset-2',
              !title && 'ml-auto',
            ]}
            data-modal-close
            aria-label="Close modal"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        )}
      </div>
    )}

    <!-- Body - Scrollable content area -->
    <div class="modal-body flex-1 overflow-y-auto px-6 py-5">
      <slot />
    </div>

    <!-- Footer slot - Optional -->
    <slot name="footer" />
  </div>
</div>

<style is:global>
  /**
   * Modal Styles
   * Uses CSS custom properties from tokens.css
   */

  /* Base hidden state */
  .modal-root {
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    z-index: var(--z-modal);
    transition:
      visibility 0s var(--duration-normal),
      opacity var(--duration-normal) var(--ease-out);
  }

  .modal-backdrop {
    opacity: 0;
    transition: opacity var(--duration-normal) var(--ease-out);
  }

  .modal-panel {
    opacity: 0;
    transform: translateY(16px) scale(0.98);
    transition:
      opacity var(--duration-normal) var(--ease-out),
      transform var(--duration-normal) var(--ease-out);
  }

  /* Open state - activated via data-open attribute */
  .modal-root[data-open="true"] {
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
    transition:
      visibility 0s,
      opacity var(--duration-normal) var(--ease-out);
  }

  .modal-root[data-open="true"] .modal-backdrop {
    opacity: 1;
  }

  .modal-root[data-open="true"] .modal-panel {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  /* Body scroll lock when modal is open */
  body.modal-open {
    overflow: hidden;
  }

  /* Focus trap indicator - subtle ring around modal when focus is trapped */
  .modal-panel:focus {
    outline: none;
  }

  /* Custom scrollbar for modal body */
  .modal-body::-webkit-scrollbar {
    width: 8px;
  }

  .modal-body::-webkit-scrollbar-track {
    background: var(--color-surface-secondary);
    border-radius: var(--radius-full);
  }

  .modal-body::-webkit-scrollbar-thumb {
    background: var(--color-border-primary);
    border-radius: var(--radius-full);
  }

  .modal-body::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
  }

  /* Reduced motion - disable animations */
  @media (prefers-reduced-motion: reduce) {
    .modal-root,
    .modal-backdrop,
    .modal-panel {
      transition: none;
    }

    .modal-panel {
      transform: none;
    }
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .modal-root {
      align-items: flex-end;
      padding: 0;
    }

    .modal-panel {
      max-height: calc(100vh - 2rem);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      margin-top: 2rem;
    }

    .modal-root[data-open="true"] .modal-panel {
      transform: translateY(0);
    }

    .modal-panel {
      transform: translateY(100%);
    }
  }
</style>

<script is:inline>
  /**
   * Modal JavaScript Controller
   * Handles:
   * - Opening/closing modals
   * - Focus trap
   * - Escape key handling
   * - Backdrop click to close
   * - Body scroll lock
   */

  class ModalController {
    constructor(modal) {
      this.modal = modal;
      this.previousActiveElement = null;
      this.focusableElements = [];
      this.init();
    }

    init() {
      // Set up close button(s)
      const closeButtons = this.modal.querySelectorAll('[data-modal-close]');
      closeButtons.forEach((btn) => {
        btn.addEventListener('click', () => this.close());
      });

      // Backdrop click to close
      const backdrop = this.modal.querySelector('[data-modal-backdrop]');
      if (backdrop) {
        backdrop.addEventListener('click', () => this.close());
      }

      // Escape key to close
      this.modal.addEventListener('keydown', (e) => this.handleKeyDown(e));

      // Watch for data-open attribute changes
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'data-open') {
            const isOpen = this.modal.getAttribute('data-open') === 'true';
            if (isOpen) {
              this.onOpen();
            } else {
              this.onClose();
            }
          }
        });
      });

      observer.observe(this.modal, { attributes: true });
    }

    open() {
      this.modal.setAttribute('data-open', 'true');
    }

    close() {
      this.modal.removeAttribute('data-open');
    }

    onOpen() {
      // Save current focus
      this.previousActiveElement = document.activeElement;

      // Lock body scroll
      document.body.classList.add('modal-open');

      // Update aria-hidden
      this.modal.setAttribute('aria-hidden', 'false');

      // Get all focusable elements
      this.focusableElements = Array.from(
        this.modal.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        )
      ).filter((el) => !el.hasAttribute('disabled') && el.offsetParent !== null);

      // Focus first element (or close button)
      setTimeout(() => {
        const firstFocusable = this.focusableElements[0];
        if (firstFocusable) {
          firstFocusable.focus();
        }
      }, 50);

      // Dispatch custom event
      this.modal.dispatchEvent(new CustomEvent('modal:open', { bubbles: true }));
    }

    onClose() {
      // Unlock body scroll
      document.body.classList.remove('modal-open');

      // Update aria-hidden
      this.modal.setAttribute('aria-hidden', 'true');

      // Restore focus
      if (this.previousActiveElement) {
        this.previousActiveElement.focus();
      }

      // Dispatch custom event
      this.modal.dispatchEvent(new CustomEvent('modal:close', { bubbles: true }));
    }

    handleKeyDown(e) {
      const isOpen = this.modal.getAttribute('data-open') === 'true';
      if (!isOpen) return;

      // Escape to close
      if (e.key === 'Escape') {
        e.preventDefault();
        this.close();
        return;
      }

      // Tab trap
      if (e.key === 'Tab') {
        const firstElement = this.focusableElements[0];
        const lastElement = this.focusableElements[this.focusableElements.length - 1];

        if (e.shiftKey) {
          // Shift + Tab - go backwards
          if (document.activeElement === firstElement) {
            e.preventDefault();
            if (lastElement) {
              lastElement.focus();
            }
          }
        } else {
          // Tab - go forwards
          if (document.activeElement === lastElement) {
            e.preventDefault();
            if (firstElement) {
              firstElement.focus();
            }
          }
        }
      }
    }
  }

  // Initialize all modals on page load
  function initModals() {
    const modals = document.querySelectorAll('[data-modal]');
    modals.forEach((modal) => {
      // Check if already initialized
      if (!modal.hasAttribute('data-modal-initialized')) {
        new ModalController(modal);
        modal.setAttribute('data-modal-initialized', 'true');
      }
    });
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', initModals);

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initModals);

  // Helper functions for opening/closing modals from outside
  window.openModal = function(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.setAttribute('data-open', 'true');
    }
  };

  window.closeModal = function(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.removeAttribute('data-open');
    }
  };
</script>
