---
/**
 * Floating Mobile CTA Button
 * Appears on mobile devices as a persistent action button
 * Smart show/hide based on scroll position
 */

import { getBusinessProfile } from '../../lib/getBusinessProfile';

const profile = await getBusinessProfile();
const bookingUrl = profile.contact.booking.enabled ? profile.contact.booking.url : null;
const phoneLink = `tel:${profile.contact.phone_e164}`;

interface Props {
  variant?: 'call' | 'book';
  class?: string;
}

const { variant = 'call', class: className = '' } = Astro.props;

const buttonConfig = {
  call: {
    href: phoneLink,
    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />`,
    text: 'Call Now',
    ariaLabel: 'Call us now',
  },
  book: {
    href: bookingUrl || phoneLink,
    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />`,
    text: 'Get Quote',
    ariaLabel: 'Book an appointment',
  },
};

const config = buttonConfig[variant];
---

<!-- Floating CTA - Only visible on mobile/tablet (< lg breakpoint) -->
<div
  id="floating-cta"
  class={`fixed bottom-6 right-6 z-40 lg:hidden transition-all duration-300 ${className}`}
  data-floating-cta
>
  <a
    href={config.href}
    class="group flex items-center gap-2 rounded-full bg-brand-orange px-6 py-4 text-white shadow-2xl transition-all hover:scale-105 hover:shadow-3xl focus:outline-none focus:ring-4 focus:ring-brand-orange/50"
    aria-label={config.ariaLabel}
    data-cta-context="floating-mobile"
    target={variant === 'book' && bookingUrl ? '_blank' : undefined}
    rel={variant === 'book' && bookingUrl ? 'noopener noreferrer' : undefined}
  >
    <!-- Icon -->
    <svg
      class="h-5 w-5 transition-transform group-hover:scale-110"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      aria-hidden="true"
    >
      <Fragment set:html={config.icon} />
    </svg>

    <!-- Text -->
    <span class="text-sm font-bold whitespace-nowrap">{config.text}</span>

    <!-- Pulse indicator -->
    <span class="absolute -top-1 -right-1 flex h-3 w-3">
      <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-white opacity-75"></span>
      <span class="relative inline-flex h-3 w-3 rounded-full bg-white"></span>
    </span>
  </a>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const floatingCTA = document.querySelector('[data-floating-cta]') as HTMLElement;
    if (!floatingCTA) return;

    let lastScrollTop = 0;
    let ticking = false;

    const handleScroll = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // Hide if at the very top (first 200px)
      if (scrollTop < 200) {
        floatingCTA.style.opacity = '0';
        floatingCTA.style.transform = 'translateY(100px) scale(0.8)';
        floatingCTA.style.pointerEvents = 'none';
      }
      // Hide if near bottom (within 300px of footer CTA)
      else if (scrollTop + windowHeight > documentHeight - 300) {
        floatingCTA.style.opacity = '0';
        floatingCTA.style.transform = 'translateY(100px) scale(0.8)';
        floatingCTA.style.pointerEvents = 'none';
      }
      // Show when scrolling up
      else if (scrollTop < lastScrollTop) {
        floatingCTA.style.opacity = '1';
        floatingCTA.style.transform = 'translateY(0) scale(1)';
        floatingCTA.style.pointerEvents = 'auto';
      }
      // Hide when scrolling down fast
      else if (scrollTop > lastScrollTop + 50) {
        floatingCTA.style.opacity = '0';
        floatingCTA.style.transform = 'translateY(20px) scale(0.95)';
        floatingCTA.style.pointerEvents = 'none';
      }

      lastScrollTop = scrollTop;
      ticking = false;
    };

    const requestTick = () => {
      if (!ticking) {
        window.requestAnimationFrame(handleScroll);
        ticking = true;
      }
    };

    window.addEventListener('scroll', requestTick, { passive: true });

    // Initial state
    handleScroll();
  });
</script>

<style>
  [data-floating-cta] {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
</style>
