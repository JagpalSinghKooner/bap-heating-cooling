---
/**
 * Location Page - Gutted for Redesign
 *
 * Preserves all data fetching, routing logic, and schemas.
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../../lib/getBusinessProfile';
import { getLocationSchema } from '../../lib/schema';
import { getLocationBreadcrumbs, getBreadcrumbSchema } from '../../lib/breadcrumbs';
import { resolveFAQs } from '../../lib/faqResolver';
import { generateFAQSchema } from '../../lib/faqSchema';
import { getReviewsForPage } from '../../lib/reviewResolver';
import { generateReviewSchemas } from '../../lib/reviewSchema';

export async function getStaticPaths() {
  const locations = await getCollection('locations');
  // Helper to remove .md extension
  const cleanSlug = (id: string) => id.replace(/\.md$/, '');

  return locations.map((location) => ({
    params: { slug: cleanSlug(location.id) },
    props: { location },
  }));
}

const { location } = Astro.props;
const { Content } = await location.render();

// Helper to remove .md extension
const cleanSlug = (id: string) => id.replace(/\.md$/, '');

const title = location.data.seoTitle || `${location.data.title} - B.A.P Heating and Cooling`;
const description = location.data.seoDescription || location.data.description;
const robots = location.data.robots || 'index,follow';

// Get all services for this location
const services = await getCollection('services');

// Get region for this location
const allRegions = (await getCollection('regions'));
const locationRegion = allRegions.find((r) =>
  r.data.cities.includes(cleanSlug(location.id))
);

// Get business profile and schema
const profile = await getBusinessProfile();

// Get location slug
const locationSlug = cleanSlug(location.id);

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Load all reviews
const allReviews = await getCollection('reviews');

// Get reviews for this page
const pageReviews = getReviewsForPage(allReviews, {
  pageType: 'location',
  locationSlug: locationSlug,
  citySlug: locationSlug,
});

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(pageReviews);

// Generate breadcrumb schema
const breadcrumbItems = getLocationBreadcrumbs(location.data.title, locationSlug);
const breadcrumbSchema = getBreadcrumbSchema(breadcrumbItems, 'https://bapheating.ca');

// Resolve FAQs for this page
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: 'location',
  locationSlug: locationSlug,
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Build schema array
const schemas = [
  getLocationSchema(profile, {
    title: location.data.title,
    region: location.data.region,
    description: location.data.description,
  }),
  breadcrumbSchema,
];

// Add FAQ schema if available
if (faqSchema) {
  schemas.push(faqSchema);
}

// Add review schemas if available
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;
---

<BaseLayout
  title={title}
  description={description}
  robots={robots}
  schema={schema}
>
  <div class="redesign-placeholder">
    <h1>HVAC Services in {location.data.title}, ON</h1>
    <p>Location page redesign in progress. {services.length} services available here.</p>
  </div>
</BaseLayout>
