---
/**
 * Location Page - Redesigned
 *
 * City-specific landing page with localized services, reviews, and trust signals.
 * Emphasizes local expertise and drives phone calls.
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile, getPhoneLink } from '../../lib/getBusinessProfile';
import { getLocationSchema } from '../../lib/schema';
import { getLocationBreadcrumbs, getBreadcrumbSchema } from '../../lib/breadcrumbs';
import { resolveFAQs } from '../../lib/faqResolver';
import { generateFAQSchema } from '../../lib/faqSchema';
import { getReviewsForPage } from '../../lib/reviewResolver';
import { generateReviewSchemas } from '../../lib/reviewSchema';

// Components
import PageHero from '../../components/shared/PageHero.astro';
import TrustSignals from '../../components/shared/TrustSignals.astro';
import ServicesGrid from '../../components/shared/ServicesGrid.astro';
import ReviewsCarousel from '../../components/shared/ReviewsCarousel.astro';
import MapEmbed from '../../components/shared/MapEmbed.astro';
import FAQSection from '../../components/shared/FAQSection.astro';
import CTASection from '../../components/shared/CTASection.astro';
import Section from '../../components/primitives/Section.astro';
import Container from '../../components/primitives/Container.astro';

export async function getStaticPaths() {
  const locations = await getCollection('locations');
  // Helper to remove .md extension
  const cleanSlug = (id: string) => id.replace(/\.md$/, '');

  return locations.map((location) => ({
    params: { slug: cleanSlug(location.id) },
    props: { location },
  }));
}

const { location } = Astro.props;
const { Content } = await location.render();

// Helper to remove .md extension
const cleanSlug = (id: string) => id.replace(/\.md$/, '');

const title = location.data.seoTitle || `${location.data.title} - B.A.P Heating and Cooling`;
const description = location.data.seoDescription || location.data.description;
const robots = location.data.robots || 'index,follow';

// Get all services for this location
const services = await getCollection('services');

// Get region for this location
const allRegions = (await getCollection('regions'));
const locationRegion = allRegions.find((r) =>
  r.data.cities.includes(cleanSlug(location.id))
);

// Get business profile and schema
const profile = await getBusinessProfile();

// Get location slug
const locationSlug = cleanSlug(location.id);

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Load all reviews
const allReviews = await getCollection('reviews');

// Get reviews for this page
const pageReviews = getReviewsForPage(allReviews, {
  pageType: 'location',
  locationSlug: locationSlug,
  citySlug: locationSlug,
});

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(pageReviews);

// Generate breadcrumb schema
const breadcrumbItems = getLocationBreadcrumbs(location.data.title, locationSlug);
const breadcrumbSchema = getBreadcrumbSchema(breadcrumbItems, 'https://bapheating.ca');

// Resolve FAQs for this page
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: 'location',
  locationSlug: locationSlug,
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Build schema array
const schemas = [
  getLocationSchema(profile, {
    title: location.data.title,
    region: location.data.region,
    description: location.data.description,
  }),
  breadcrumbSchema,
];

// Add FAQ schema if available
if (faqSchema) {
  schemas.push(faqSchema);
}

// Add review schemas if available
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;

// Get phone link for CTAs
const phoneLink = getPhoneLink(profile);

// Map FAQs for FAQSection component
const faqItems = pageFAQs.map(faq => ({
  question: faq.data.question,
  answer: faq.data.answer,
}));
---

<BaseLayout
  title={title}
  description={description}
  robots={robots}
  schema={schema}
>
  {/* Hero Section - Location variant emphasizes local trust */}
  <PageHero
    title={`HVAC Services in ${location.data.title}`}
    description={location.data.description || `Professional heating, cooling, and indoor air quality services for homes and businesses in ${location.data.title}. Family-owned since 1992.`}
    eyebrow={`Serving ${location.data.title}, Ontario`}
    variant="location"
    breadcrumbs={breadcrumbItems}
    ctaButtons={[
      {
        label: 'Call Now',
        href: phoneLink,
        variant: 'primary',
        icon: 'phone',
      },
      {
        label: 'View Services',
        href: '#services',
        variant: 'outline',
      },
    ]}
  />

  {/* Trust Signals - Location-specific review count */}
  <Section variant="default" padding="sm">
    <Container size="xl">
      <TrustSignals
        variant="horizontal"
        showRating={true}
        showReviewCount={true}
        showYears={true}
        showLicense={true}
        showEmergency={true}
      />
    </Container>
  </Section>

  {/* Services Grid - Links to service-city pages */}
  <Section variant="muted" padding="lg" id="services">
    <Container size="xl">
      <ServicesGrid
        locationSlug={locationSlug}
        columns={3}
        variant="cards"
        showDescription={true}
        showCategory={true}
        title={`Our Services in ${location.data.title}`}
        eyebrow="What We Offer"
        description={`Complete HVAC solutions for ${location.data.title} homes and businesses. Click any service to learn about local availability and pricing.`}
        headerAlign="center"
      />
    </Container>
  </Section>

  {/* Reviews Carousel - Filtered by location */}
  {pageReviews.length > 0 && (
    <ReviewsCarousel
      filterBy={{ locationSlug: locationSlug }}
      limit={6}
      title={`What ${location.data.title} Customers Say`}
      eyebrow="Customer Reviews"
      description={`Real reviews from our neighbors in ${location.data.title}.`}
      showNavigation={true}
      showDots={true}
      variant="default"
      showSummary={true}
    />
  )}

  {/* Map Embed - Show business location */}
  <Section variant="muted" padding="md">
    <Container size="lg">
      <MapEmbed
        title={`Serving ${location.data.title} & Surrounding Areas`}
        variant="featured"
        aspectRatio="16/9"
        lazy={true}
      />
    </Container>
  </Section>

  {/* FAQ Section - Location-scoped */}
  {faqItems.length > 0 && (
    <FAQSection
      faqs={faqItems}
      title={`Common Questions in ${location.data.title}`}
      eyebrow="FAQ"
      description={`Answers to frequently asked questions from ${location.data.title} homeowners.`}
      columns={1}
      variant="default"
      accordionVariant="bordered"
      showCTA={true}
      ctaHeadline="Have a different question?"
      ctaLabel="Call Us"
      ctaHref={phoneLink}
    />
  )}

  {/* CTA Section - Final conversion push */}
  <CTASection
    variant="primary"
    headline={`Ready for Expert HVAC Service in ${location.data.title}?`}
    description={`From emergency repairs to new installations, our team is ready to help. Call now for fast, reliable service.`}
    primaryCTA={{
      label: 'Call Now',
      href: phoneLink,
    }}
    secondaryCTA={{
      label: 'Book Online',
      href: '/contact-us/',
    }}
    showPhone={true}
    showHours={true}
    align="center"
  />
</BaseLayout>
