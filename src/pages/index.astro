---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/hero/Hero.astro';
import ReviewsBlock from '../components/ReviewsBlock.astro';
import Button from '../components/primitives/Button.astro';
import ServiceCategoriesSection from '../components/homepage/ServiceCategoriesSection.astro';
import TrustSignalsSection from '../components/homepage/TrustSignalsSection.astro';
import DifferentiationSection from '../components/homepage/DifferentiationSection.astro';
import TeamSection from '../components/homepage/TeamSection.astro';
import GallerySection from '../components/homepage/GallerySection.astro';
import ProcessSection from '../components/homepage/ProcessSection.astro';
import ServiceAreasSection from '../components/homepage/ServiceAreasSection.astro';
import FinancingTeaserSection from '../components/homepage/FinancingTeaserSection.astro';
import GuaranteesSection from '../components/homepage/GuaranteesSection.astro';
import FAQSection from '../components/shared/FAQSection.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../lib/getBusinessProfile';
import { getLocalBusinessSchema } from '../lib/schema';
import { resolveFAQs } from '../lib/faqResolver';
import { generateFAQSchema } from '../lib/faqSchema';
import { getSiteReviewBlock } from '../lib/reviewResolver';
import { generateReviewSchemas } from '../lib/reviewSchema';

const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Resolve FAQs for homepage
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: 'homepage',
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Load reviews for homepage
const allReviews = await getCollection('reviews');
const siteReviews = getSiteReviewBlock(allReviews);

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(siteReviews);

// Build schema array
const schemas = [getLocalBusinessSchema(profile)];
if (faqSchema) {
  schemas.push(faqSchema);
}
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;
---

<BaseLayout
  title="Home - B.A.P Heating and Cooling"
  description="Professional heating and cooling services for your home and business"
  schema={schema}
>
  <!-- 1. Hero Section + Trust Signals (Problem + promise + primary CTAs) -->
  <Hero
    eyebrow="Professional HVAC Services"
    headline="Expert Heating & Cooling Solutions for Your Home"
    description="24/7 emergency support. Licensed, insured, and trusted by homeowners across Guelph, Wellington County, and Waterloo Region."
    context="homepage-hero"
  />

  <!-- 2. Services Overview (What we do - services) -->
  <ServiceCategoriesSection />

  <!-- 3. Why Choose Us (Trust signals - benefits / guarantees) -->
  <TrustSignalsSection />

  <!-- 4. Team / Experts Section (Who will show up at my home?) -->
  <TeamSection />

  <!-- 5. Gallery / Before & After (What does the work actually look like?) -->
  <GallerySection />

  <!-- 6. How We Work (Process - how does this work?) -->
  <ProcessSection />

  <!-- 7. Testimonials (Social proof - what others say) -->
  <ReviewsBlock reviews={siteReviews} title="What Our Customers Say" />

  <!-- 8. Pricing / Financing (Can I afford it?) -->
  <FinancingTeaserSection />

  <!-- 9. Service Area (Do you serve my area?) -->
  <ServiceAreasSection />

  <!-- 10. Guarantees / Risk Removal (What risk do I take if I say yes?) -->
  <GuaranteesSection />

  <!-- 10.5. Differentiation - How We're Different -->
  <DifferentiationSection />

  <!-- 11. FAQs (What questions do I still have?) -->
  {pageFAQs.length > 0 && (
    <FAQSection faqs={pageFAQs} />
  )}

  <!-- 12. Final CTA (How do I book now?) -->
  <section class="relative overflow-hidden bg-gradient-to-br from-primary to-primary/80 py-14 md:py-20 lg:py-24">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="mx-auto max-w-4xl text-center text-white">
        <h2 class="mb-4 text-3xl font-bold sm:text-4xl lg:text-5xl">
          Ready to Get Started?
        </h2>
        <p class="mb-8 text-lg text-white/90 sm:text-xl lg:text-2xl">
          No pressure. No obligation. We'll explain your options clearly and help you make the right choice for your home.
        </p>
        <div class="flex flex-col gap-4 sm:flex-row sm:justify-center">
          <Button
            variant="secondary"
            size="lg"
            href={`tel:${profile.contact.phone_e164}`}
            data-cta-context="homepage-footer"
            class="bg-white text-primary hover:bg-gray-100 shadow-xl hover:shadow-2xl"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <span>Call {profile.contact.phone_display}</span>
          </Button>

          {profile.contact.booking.enabled && (
            <Button
              variant="outline"
              size="lg"
              href={profile.contact.booking.url}
              target="_blank"
              rel="noopener noreferrer"
              data-cta-context="homepage-footer"
              class="border-white text-white hover:bg-white hover:text-primary"
            >
              <span>Schedule Online</span>
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </Button>
          )}
        </div>
      </div>
    </div>

    {/* Background Pattern */}
    <div class="absolute inset-0 opacity-10" aria-hidden="true">
      <div class="absolute inset-0" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,.05) 20px, rgba(255,255,255,.05) 40px);" />
    </div>
  </section>
</BaseLayout>
