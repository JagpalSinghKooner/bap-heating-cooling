---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/hero/Hero.astro';
import ReviewsBlock from '../components/ReviewsBlock.astro';
import ServiceCategoriesSection from '../components/homepage/ServiceCategoriesSection.astro';
import WhyChooseBAPSection from '../components/homepage/WhyChooseBAPSection.astro';
import GallerySection from '../components/homepage/GallerySection.astro';
import ProcessSection from '../components/homepage/ProcessSection.astro';
import ServiceAreasSection from '../components/homepage/ServiceAreasSection.astro';
import FinancingTeaserSection from '../components/homepage/FinancingTeaserSection.astro';
import FinalCTASection from '../components/homepage/FinalCTASection.astro';
import FAQSection from '../components/shared/FAQSection.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../lib/getBusinessProfile';
import { getLocalBusinessSchema } from '../lib/schema';
import { resolveFAQs } from '../lib/faqResolver';
import { generateFAQSchema } from '../lib/faqSchema';
import { getSiteReviewBlock } from '../lib/reviewResolver';
import { generateReviewSchemas } from '../lib/reviewSchema';

const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Resolve FAQs for homepage
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: 'homepage',
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Load reviews for homepage
const allReviews = await getCollection('reviews');
const siteReviews = getSiteReviewBlock(allReviews);

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(siteReviews);

// Build schema array
const schemas = [getLocalBusinessSchema(profile)];
if (faqSchema) {
  schemas.push(faqSchema);
}
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;
---

<BaseLayout
  title="Home - B.A.P Heating and Cooling"
  description="Professional heating and cooling services for your home and business"
  schema={schema}
>
  <!-- 1. Hero: Problem + Promise + Primary CTAs -->
  <Hero
    eyebrow="Professional HVAC Services"
    headline="Expert Heating & Cooling Solutions for Your Home"
    description="24/7 emergency support. Licensed, insured, and trusted by homeowners across Guelph, Wellington County, and Waterloo Region."
    context="homepage-hero"
  />

  <!-- 2. Services: What we do -->
  <ServiceCategoriesSection />

  <!-- 3. Why Choose BAP: Trust + About + Differentiators (consolidated) -->
  <WhyChooseBAPSection />

  <!-- 4. Process: How it works -->
  <ProcessSection />

  <!-- 5. Gallery: Visual proof of work -->
  <GallerySection />

  <!-- 6. Reviews: Social proof -->
  <ReviewsBlock reviews={siteReviews} title="What Our Customers Say" />

  <!-- 7. Financing: Can I afford it? -->
  <FinancingTeaserSection />

  <!-- 8. Service Areas: Do you serve my area? -->
  <ServiceAreasSection />

  <!-- 9. FAQ: Address remaining objections -->
  {pageFAQs.length > 0 && (
    <FAQSection faqs={pageFAQs} />
  )}

  <!-- 10. Final CTA: One strong conversion point -->
  <FinalCTASection />
</BaseLayout>
