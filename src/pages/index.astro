---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/hero/Hero.astro';
import ReviewsBlock from '../components/ReviewsBlock.astro';
import TrustStripSection from '../components/homepage/TrustStripSection.astro';
import ServiceCategoriesSection from '../components/homepage/ServiceCategoriesSection.astro';
import ServiceIntentBand from '../components/homepage/ServiceIntentBand.astro';
import TrustSignalsSection from '../components/homepage/TrustSignalsSection.astro';
import ProcessSection from '../components/homepage/ProcessSection.astro';
import MidPageConversionAnchor from '../components/homepage/MidPageConversionAnchor.astro';
import ServiceAreasSection from '../components/homepage/ServiceAreasSection.astro';
import EmergencyCTASection from '../components/homepage/EmergencyCTASection.astro';
import FinancingTeaserSection from '../components/homepage/FinancingTeaserSection.astro';
import FAQSection from '../components/shared/FAQSection.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../lib/getBusinessProfile';
import { getLocalBusinessSchema } from '../lib/schema';
import { resolveFAQs } from '../lib/faqResolver';
import { generateFAQSchema } from '../lib/faqSchema';
import { getSiteReviewBlock } from '../lib/reviewResolver';
import { generateReviewSchemas } from '../lib/reviewSchema';

const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Resolve FAQs for homepage
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: 'homepage',
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Load reviews for homepage
const allReviews = await getCollection('reviews');
const siteReviews = getSiteReviewBlock(allReviews);

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(siteReviews);

// Build schema array
const schemas = [getLocalBusinessSchema(profile)];
if (faqSchema) {
  schemas.push(faqSchema);
}
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;
---

<BaseLayout
  title="Home - B.A.P Heating and Cooling"
  description="Professional heating and cooling services for your home and business"
  schema={schema}
>
  <!-- 1. Hero Section -->
  <Hero
    eyebrow="24/7 Emergency HVAC Services"
    headline="Expert Heating & Cooling Solutions for Your Home"
    description="Professional HVAC services with 24/7 emergency support. Licensed, insured, and trusted by homeowners across Ontario."
    showRatingCard={true}
    showTrustBadges={false}
    context="homepage-hero"
  />

  <!-- 1A. Trust Strip (NEW - Above fold trust signals) -->
  <TrustStripSection />

  <!-- 2. Service Categories (Gateway to main services) -->
  <ServiceCategoriesSection />

  <!-- 2A. Service Intent Band (NEW - Reinforces conversion after browse) -->
  <ServiceIntentBand />

  <!-- 3. Trust Signals (Why Choose Us) -->
  <TrustSignalsSection />

  <!-- 4. How It Works (Process section) -->
  <ProcessSection />

  <!-- 4A. Mid-Page Conversion Anchor (NEW - Catch scrollers) -->
  <MidPageConversionAnchor />

  <!-- 5. Service Areas (REFACTORED - Compact accordion) -->
  <ServiceAreasSection />

  <!-- 6. Reviews (ENHANCED - Larger cards, better prominence) -->
  <ReviewsBlock reviews={siteReviews} title="What Our Customers Say" />

  <!-- 7. Emergency CTA (ENHANCED - Full-width alert band) -->
  <EmergencyCTASection />

  <!-- 8. Financing (ENHANCED - Better visual treatment) -->
  <FinancingTeaserSection />

  <!-- 9. FAQs -->
  {pageFAQs.length > 0 && (
    <FAQSection faqs={pageFAQs} />
  )}

  <!-- 10. Final CTA (ENHANCED - Clear endpoint) -->
  <section class="relative overflow-hidden bg-gradient-to-br from-primary to-primary/80 py-16 sm:py-20 lg:py-24">
    <div class="section-container relative z-10">
      <div class="mx-auto max-w-4xl text-center text-white">
        <h2 class="mb-4 text-3xl font-bold sm:text-4xl lg:text-5xl">
          Ready to Get Started?
        </h2>
        <p class="mb-8 text-lg text-white/90 sm:text-xl lg:text-2xl">
          Contact us today for expert heating and cooling services
        </p>
        <div class="flex flex-col gap-4 sm:flex-row sm:justify-center">
          <a
            href={`tel:${profile.contact.phone_e164}`}
            class="inline-flex items-center justify-center gap-2 rounded-md bg-white px-8 py-4 text-lg font-bold text-primary shadow-xl transition-all hover:bg-gray-100 hover:shadow-2xl"
            data-cta-context="homepage-footer"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <span>Call {profile.contact.phone_display}</span>
          </a>

          {profile.contact.booking.enabled && (
            <a
              href={profile.contact.booking.url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 rounded-md border-2 border-white bg-transparent px-8 py-4 text-lg font-bold text-white transition-all hover:bg-white hover:text-primary"
              data-cta-context="homepage-footer"
            >
              <span>Schedule Online</span>
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </a>
          )}
        </div>
      </div>
    </div>

    {/* Background Pattern */}
    <div class="absolute inset-0 opacity-10" aria-hidden="true">
      <div class="absolute inset-0" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,.05) 20px, rgba(255,255,255,.05) 40px);" />
    </div>
  </section>
</BaseLayout>
