---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/hero/Hero.astro';
import ReviewsBlock from '../components/ReviewsBlock.astro';
import ServiceCategoriesSection from '../components/homepage/ServiceCategoriesSection.astro';
import WhyChooseBAPSection from '../components/homepage/WhyChooseBAPSection.astro';
import GallerySection from '../components/homepage/GallerySection.astro';
import ProcessSection from '../components/homepage/ProcessSection.astro';
import ServiceAreasSection from '../components/homepage/ServiceAreasSection.astro';
import FinancingTeaserSection from '../components/homepage/FinancingTeaserSection.astro';
import FinalCTASection from '../components/homepage/FinalCTASection.astro';
import FAQSection from '../components/shared/FAQSection.astro';
import EmergencyCTASection from '../components/homepage/EmergencyCTASection.astro';
import BrandLogosSection from '../components/homepage/BrandLogosSection.astro';
import BlogPreviewSection from '../components/homepage/BlogPreviewSection.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../lib/getBusinessProfile';
import { getLocalBusinessSchema } from '../lib/schema';
import { resolveFAQs } from '../lib/faqResolver';
import { generateFAQSchema } from '../lib/faqSchema';
import { getSiteReviewBlock } from '../lib/reviewResolver';
import { generateReviewSchemas } from '../lib/reviewSchema';

const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Resolve FAQs for homepage
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: 'homepage',
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Load reviews for homepage
const allReviews = await getCollection('reviews');
const siteReviews = getSiteReviewBlock(allReviews);

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(siteReviews);

// Build schema array
const schemas = [getLocalBusinessSchema(profile)];
if (faqSchema) {
  schemas.push(faqSchema);
}
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;
---

<BaseLayout
  title="Furnace & AC Installation Guelph ON | 24/7 HVAC | B.A.P Heating"
  description="24/7 emergency HVAC in Guelph & Ontario. Furnace installation, AC repair, heat pumps. Family-owned since 1994. 10-year warranty. Free estimates: 519-835-4858"
  schema={schema}
>
  <!-- 1. Hero: Problem + Promise + Primary CTAs -->
  <Hero
    eyebrow="Family-Owned Since 1994"
    headline="30+ Years Keeping Ontario Families Comfortable"
    description="Licensed TSSA technicians. Same-day service available. 10-year warranty on all installations."
    context="homepage-hero"
  />

  <!-- 2. Services: What we do -->
  <ServiceCategoriesSection />

  <!-- 3. Emergency CTA: Prominent 24/7 emergency service callout -->
  <EmergencyCTASection />

  <!-- 4. Why Choose BAP: Trust + About + Differentiators (consolidated) -->
  <WhyChooseBAPSection />

  <!-- 5. Brand Logos: Manufacturer trust indicators -->
  <BrandLogosSection />

  <!-- 6. Process: How it works -->
  <ProcessSection />

  <!-- 7. Gallery: Visual proof of work -->
  <GallerySection />

  <!-- 8. Reviews: Social proof -->
  <ReviewsBlock reviews={siteReviews} title="What Our Customers Say" />

  <!-- 9. Financing: Can I afford it? -->
  <FinancingTeaserSection />

  <!-- 10. Service Areas: Do you serve my area? -->
  <ServiceAreasSection />

  <!-- 11. Blog: Expert advice and guides -->
  <BlogPreviewSection />

  <!-- 12. FAQ: Address remaining objections -->
  {pageFAQs.length > 0 && (
    <FAQSection faqs={pageFAQs} />
  )}

  <!-- 13. Final CTA: One strong conversion point -->
  <FinalCTASection />
</BaseLayout>
