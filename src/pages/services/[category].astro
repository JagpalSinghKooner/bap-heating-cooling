---
/**
 * Service Category Page
 *
 * Displays all services within a category (e.g., Heating, Cooling).
 * Uses PageHero, ServicesGrid, ReviewsCarousel, and CTASection.
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../../lib/getBusinessProfile';
import { getLocalBusinessSchema } from '../../lib/schema';
import type { RegionLocationMap } from '../../lib/types';

// Page Components
import PageHero from '../../components/shared/PageHero.astro';
import ServicesGrid from '../../components/shared/ServicesGrid.astro';
import ReviewsCarousel from '../../components/shared/ReviewsCarousel.astro';
import CTASection from '../../components/shared/CTASection.astro';
import Section from '../../components/primitives/Section.astro';
import Container from '../../components/primitives/Container.astro';

export async function getStaticPaths() {
  const categories = [
    {
      slug: 'heating',
      title: 'Heating Services',
      description: 'Professional heating installation, repair, and maintenance services for your home or business.',
      category: 'heating'
    },
    {
      slug: 'cooling',
      title: 'Cooling Services',
      description: 'Expert air conditioning installation, repair, and maintenance to keep you comfortable all summer.',
      category: 'cooling'
    },
    {
      slug: 'indoor-air-quality',
      title: 'Indoor Air Quality Services',
      description: 'Improve your indoor air quality with our professional air filtration, purification, and ventilation solutions.',
      category: 'iaq'
    },
    {
      slug: 'water-heating',
      title: 'Water Heating Services',
      description: 'Reliable water heater installation, repair, and maintenance for consistent hot water.',
      category: 'water-heating'
    },
    {
      slug: 'commercial',
      title: 'Commercial HVAC Services',
      description: 'Comprehensive commercial heating, cooling, and ventilation solutions for businesses of all sizes.',
      category: 'commercial'
    },
    {
      slug: 'maintenance-plans',
      title: 'HVAC Maintenance Plans',
      description: 'Preventive maintenance plans to keep your HVAC system running efficiently year-round.',
      category: 'plans'
    },
  ];

  return categories.map((cat) => ({
    params: { category: cat.slug },
    props: cat,
  }));
}

const { title, description, category } = Astro.props;

// Load all services and filter by category
const allServices = await getCollection('services');
const categoryServices = allServices
  .filter(s => s.data.category === category)
  .sort((a, b) => a.data.order - b.data.order);

// Load all locations for service-city links
const allLocations = await getCollection('locations');

// Load all regions
const allRegions = await getCollection('regions');

// Group locations by region
const cleanSlug = (id: string) => id.replace(/\.md$/, '');
const locationsByRegion: Map<string, RegionLocationMap> = new Map();

for (const region of allRegions) {
  const regionSlug = cleanSlug(region.id);
  const regionLocations = allLocations.filter((loc) =>
    region.data.cities.includes(cleanSlug(loc.id))
  );
  locationsByRegion.set(regionSlug, {
    region: region,
    locations: regionLocations
  });
}

// Get business profile
const profile = await getBusinessProfile();

// Load reviews
const allReviews = await getCollection('reviews');
const liveReviews = allReviews.filter(r => r.data.status === 'live');

// Schema
const schema = getLocalBusinessSchema(profile);

const seoTitle = `${title} - B.A.P Heating and Cooling`;
const seoDescription = description;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  robots="index,follow"
  schema={schema}
>
  {/* Page Hero */}
  <PageHero
    title={title}
    description={description}
    eyebrow="Our Services"
    variant="default"
    breadcrumbs={[
      { label: 'Home', href: '/' },
      { label: 'Services', href: '/services/' },
      { label: title, href: `/services/${Astro.params.category}/` },
    ]}
  />

  {/* Services Grid - Shows all services in this category */}
  <Section variant="default" padding="lg">
    <Container size="xl">
      <ServicesGrid
        filterByCategory={category}
        columns={3}
        showDescription={true}
        showServiceType={true}
        showCategory={false}
        title={`${title}`}
        eyebrow={`${categoryServices.length} Services Available`}
        description="Professional installation, repair, and maintenance services for your home or business."
      />
    </Container>
  </Section>

  {/* Reviews Carousel */}
  <Section variant="muted" padding="lg">
    <Container size="xl">
      <ReviewsCarousel
        limit={8}
        title="What Our Customers Say"
      />
    </Container>
  </Section>

  {/* CTA Section */}
  <CTASection
    variant="primary"
    headline={`Need ${title}?`}
    description="Our certified technicians are ready to help with all your HVAC needs. Contact us today for fast, reliable service."
    primaryCTA={{
      label: 'Get a Free Quote',
      href: '/contact-us/',
    }}
    secondaryCTA={{
      label: 'Call (905) 301-2195',
      href: 'tel:+19053012195',
    }}
    showPhone={true}
  />
</BaseLayout>
