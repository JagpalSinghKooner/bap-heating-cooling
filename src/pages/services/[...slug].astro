---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ReviewsBlock from '../../components/ReviewsBlock.astro';
import PrimaryCTA from '../../components/PrimaryCTA.astro';
import TrustBadges from '../../components/TrustBadges.astro';
import ServiceDetailsGrid from '../../components/services/ServiceDetailsGrid.astro';
import FAQSection from '../../components/shared/FAQSection.astro';
import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../../lib/getBusinessProfile';
import { getServiceSchema, getLocalBusinessSchema } from '../../lib/schema';
import { getServiceBreadcrumbs, getServiceCityBreadcrumbs, getBreadcrumbSchema, type BreadcrumbItem } from '../../lib/breadcrumbs';
import { resolveFAQs } from '../../lib/faqResolver';
import { generateFAQSchema } from '../../lib/faqSchema';
import { getReviewsForPage } from '../../lib/reviewResolver';
import { generateReviewSchemas } from '../../lib/reviewSchema';

export async function getStaticPaths() {
  const services = await getCollection('services');
  const locations = await getCollection('locations');

  const paths = [];

  // Helper to remove .md extension
  const cleanSlug = (id: string) => id.replace(/\.md$/, '');

  // Generate paths for individual service pages
  for (const service of services) {
    paths.push({
      params: {
        slug: cleanSlug(service.id)
      },
      props: {
        type: 'service',
        service,
        location: null,
      },
    });
  }

  // Generate paths for service-in-city pages
  for (const service of services) {
    for (const location of locations) {
      paths.push({
        params: {
          slug: `${cleanSlug(service.id)}-${cleanSlug(location.id)}-on`
        },
        props: {
          type: 'service-city',
          service,
          location,
        },
      });
    }
  }

  return paths;
}

const { type, service, location } = Astro.props;

// Helper to remove .md extension
const cleanSlug = (id: string) => id.replace(/\.md$/, '');

// Prepare data based on type
let title: string;
let description: string;
let robots: string;
let Content: any = null;

if (type === 'service') {
  const rendered = await service.render();
  Content = rendered.Content;
  title = service.data.seoTitle || `${service.data.title} - B.A.P Heating and Cooling`;
  description = service.data.seoDescription || service.data.description;
  robots = service.data.robots || 'index,follow';
} else if (type === 'service-city' && location) {
  title = `${service.data.title} in ${location.data.title}, ON - B.A.P Heating and Cooling`;
  description = `Professional ${service.data.title.toLowerCase()} services in ${location.data.title}, Ontario. ${service.data.description}`;
  robots = service.data.robots || location.data.robots || 'index,follow';
} else {
  title = 'B.A.P Heating and Cooling';
  description = 'Professional heating and cooling services';
  robots = 'index,follow';
}

const serviceSlug = cleanSlug(service.id);
const locationSlug = location ? cleanSlug(location.id) : null;

// Get business profile and generate schema
const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Load all reviews
const allReviews = await getCollection('reviews');

// Get reviews for this page
const pageReviews = getReviewsForPage(allReviews, {
  pageType: type === 'service' ? 'service' : 'service-city',
  serviceSlug: serviceSlug,
  locationSlug: locationSlug || undefined,
  citySlug: locationSlug || undefined,
});

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(pageReviews);

// Generate breadcrumb schema
let breadcrumbItems: BreadcrumbItem[];
if (type === 'service') {
  breadcrumbItems = getServiceBreadcrumbs(service.data.title, serviceSlug);
} else if (type === 'service-city' && location) {
  const combinedSlug = `${serviceSlug}-${locationSlug}-on`;
  breadcrumbItems = getServiceCityBreadcrumbs(
    service.data.title,
    serviceSlug,
    location.data.title,
    locationSlug!,
    combinedSlug
  );
} else {
  breadcrumbItems = [];
}
const breadcrumbSchema = breadcrumbItems.length > 0
  ? getBreadcrumbSchema(breadcrumbItems, 'https://bapheating.ca')
  : null;

// Resolve FAQs for this page
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: type === 'service' ? 'service' : 'service-city',
  serviceSlug: serviceSlug,
  locationSlug: locationSlug || undefined,
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Build schema array
let schemas = [];
if (type === 'service') {
  schemas.push(getServiceSchema(profile, {
    title: service.data.title,
    description: service.data.description,
    slug: serviceSlug,
  }));
} else if (type === 'service-city' && location) {
  schemas.push(
    getLocalBusinessSchema(profile),
    getServiceSchema(
      profile,
      {
        title: service.data.title,
        description: service.data.description,
        slug: serviceSlug,
      },
      {
        title: location.data.title,
        slug: locationSlug!,
      }
    )
  );
} else {
  schemas.push(getLocalBusinessSchema(profile));
}

// Add breadcrumb schema if available
if (breadcrumbSchema) {
  schemas.push(breadcrumbSchema);
}

// Add FAQ schema if available
if (faqSchema) {
  schemas.push(faqSchema);
}

// Add review schemas if available
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;

// P0-2 fix: Get all locations and regions for service pages
let allLocations: any[] = [];
let allRegions: any[] = [];
let locationsByRegion: Map<string, { region: any; locations: any[] }> = new Map();

if (type === 'service') {
  allLocations = await getCollection('locations');
  allRegions = await getCollection('regions');

  // Group locations by region
  for (const region of allRegions) {
    const regionSlug = cleanSlug(region.id);
    const regionLocations = allLocations.filter((loc) =>
      region.data.cities.includes(cleanSlug(loc.id))
    );
    locationsByRegion.set(regionSlug, {
      region: region,
      locations: regionLocations
    });
  }
}

// P0-4 fix: Get all services for service-in-city pages
let allServices: any[] = [];
let relatedServices: any[] = [];

if (type === 'service-city') {
  allServices = await getCollection('services');
  relatedServices = allServices.filter((s) => cleanSlug(s.id) !== serviceSlug);
}

// P0-3 fix: Get region for service-in-city pages
let parentRegion = null;

if (type === 'service-city' && location && locationSlug) {
  allRegions = await getCollection('regions');
  parentRegion = allRegions.find((region) =>
    region.data.cities.includes(locationSlug)
  );
}
---

<BaseLayout
  title={title}
  description={description}
  robots={robots}
  schema={schema}
>
  {type === 'service' ? (
    <>
      <!-- Breadcrumb -->
      <div class="border-b bg-muted/30">
        <div class="section-container py-4">
          <a href="/services/" class="text-sm text-muted-foreground hover:text-primary">
            ← Back to Services
          </a>
        </div>
      </div>

      <!-- 1. Hero Section -->
      <section class="section-hero">
        <div class="section-container">
          <article class="prose prose-lg mx-auto max-w-none">
            <Content />
          </article>

          <TrustBadges class="mt-8" />

          <div class="cta-group-mobile-full mx-auto mt-8 max-w-md">
            <PrimaryCTA variant="call" context="service-above-fold" size="large" />
            <PrimaryCTA variant="book" context="service-above-fold" size="large" />
          </div>
        </div>
      </section>

      <!-- 2. Service Details -->
      <ServiceDetailsGrid />

      <!-- 3. Service Areas Section -->
      <section class="section bg-muted/30">
        <div class="section-container">
          <h2 class="mb-8 text-center text-3xl font-bold">Areas We Serve for {service.data.title}</h2>
          {Array.from(locationsByRegion.entries()).map(([_, { region, locations }]) => (
            <div class="mb-10">
              <h3 class="mb-4 text-xl font-semibold">{region.data.title}</h3>
              <div class="grid-responsive-4">
                {locations.map((loc: any) => (
                  <a
                    href={`/services/${serviceSlug}-${cleanSlug(loc.id)}-on/`}
                    class="card-compact"
                  >
                    <span class="text-sm font-medium">{loc.data.title}</span>
                  </a>
                ))}
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- 4. Reviews Section -->
      <ReviewsBlock reviews={pageReviews} title="Customer Reviews" />

      <!-- 5. FAQs -->
      {pageFAQs.length > 0 && (
        <FAQSection faqs={pageFAQs} />
      )}

      <!-- 6. CTA Conversion -->
      <section class="section bg-muted/30">
        <div class="section-container">
          <div class="card-cta mx-auto max-w-3xl text-center">
            <h2 class="mb-4 text-2xl font-semibold">Need {service.data.title}?</h2>
            <p class="mb-6 text-muted-foreground">
              Contact us today to schedule a consultation or request service.
            </p>
            <div class="cta-group justify-center">
              <PrimaryCTA variant="call" context="service-footer" />
              <PrimaryCTA variant="book" context="service-footer" />
            </div>
          </div>
        </div>
      </section>
    </>
  ) : location ? (
    <>
      <!-- Breadcrumb -->
      <div class="border-b bg-muted/30">
        <div class="section-container py-4">
          <div class="flex flex-wrap gap-2 text-sm text-muted-foreground">
            <a href="/services/" class="hover:text-primary">Services</a>
            <span>/</span>
            <a href={`/services/${serviceSlug}/`} class="hover:text-primary">{service.data.title}</a>
            <span>/</span>
            {parentRegion && (
              <>
                <a href={`/regions/${cleanSlug(parentRegion.id)}/`} class="hover:text-primary">{parentRegion.data.title}</a>
                <span>/</span>
              </>
            )}
            <a href={`/locations/${locationSlug}/`} class="hover:text-primary">{location.data.title}</a>
          </div>
        </div>
      </div>

      <!-- 1. Hero Section -->
      <section class="section-hero">
        <div class="section-container">
          <h1 class="mb-6 text-center text-4xl font-bold sm:text-5xl">
            {service.data.title} in {location.data.title}, ON
          </h1>

          <p class="mx-auto mb-8 max-w-3xl text-center text-lg text-muted-foreground sm:text-xl">
            Professional {service.data.title.toLowerCase()} services in {location.data.title}, Ontario. {service.data.description}
          </p>

          <TrustBadges class="mb-8" />

          <!-- Emergency CTA Block - FIXED: Changed from red alert to warm urgent styling -->
          <div class="card-urgent mx-auto mb-8 max-w-2xl text-center">
            <h2 class="mb-4 text-xl font-semibold text-orange-900">Need Service Now?</h2>
            <div class="cta-group-mobile-full">
              <PrimaryCTA variant="emergency" context="service-city-hero" />
              <PrimaryCTA variant="call" context="service-city-hero" />
              <PrimaryCTA variant="book" context="service-city-hero" />
            </div>
          </div>
        </div>
      </section>

      <!-- 2. Service Info Section (local_context + service_details) -->
      <section class="section bg-muted/30">
        <div class="section-container">
          <div class="grid-responsive-2">
            <div class="card-standard">
              <h2 class="mb-4 text-2xl font-semibold">About This Service</h2>
              <p class="mb-4 text-muted-foreground">
                {service.data.description}
              </p>
              <a
                href={`/services/${serviceSlug}/`}
                class="text-primary hover:underline"
              >
                Learn more about {service.data.title} →
              </a>
            </div>

            <div class="card-standard">
              <h2 class="mb-4 text-2xl font-semibold">Service Area</h2>
              <p class="mb-4 text-muted-foreground">
                We provide {service.data.title.toLowerCase()} services throughout {location.data.title} and surrounding areas in {location.data.region}.
              </p>
              <a
                href={`/locations/${locationSlug}/`}
                class="text-primary hover:underline"
              >
                View all services in {location.data.title} →
              </a>
            </div>
          </div>
        </div>
      </section>

      <!-- 3. Related Services -->
      <section class="section">
        <div class="section-container">
          <h2 class="mb-8 text-center text-3xl font-bold">Other HVAC Services in {location.data.title}</h2>
          <div class="grid-responsive-4">
            {relatedServices.map((relatedService: any) => (
              <a
                href={`/services/${cleanSlug(relatedService.id)}-${locationSlug}-on/`}
                class="card-compact"
              >
                <span class="text-sm font-medium">{relatedService.data.title}</span>
              </a>
            ))}
          </div>
        </div>
      </section>

      <!-- 4. Reviews Section -->
      <ReviewsBlock reviews={pageReviews} title="Customer Reviews" />

      <!-- 5. FAQs -->
      {pageFAQs.length > 0 && (
        <FAQSection faqs={pageFAQs} />
      )}

      <!-- 6. CTA Conversion -->
      <section class="section bg-muted/30">
        <div class="section-container">
          <div class="card-cta mx-auto max-w-3xl text-center">
            <h2 class="mb-4 text-2xl font-semibold">
              Need {service.data.title} in {location.data.title}?
            </h2>
            <p class="mb-6 text-muted-foreground">
              Contact us today to schedule {service.data.title.toLowerCase()} service in {location.data.title}, ON.
            </p>
            <div class="cta-group-mobile-full">
              <PrimaryCTA variant="emergency" context="service-city-footer" />
              <PrimaryCTA variant="call" context="service-city-footer" />
              <PrimaryCTA variant="book" context="service-city-footer" />
            </div>
          </div>
        </div>
      </section>
    </>
  ) : null}
</BaseLayout>
