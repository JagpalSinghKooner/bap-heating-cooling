---
/**
 * Service/Service-City Page - Gutted for Redesign
 *
 * Preserves all data fetching, routing logic, and schemas.
 * Visual components will be rebuilt in Phase 5-6.
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';
import { getBusinessProfile } from '../../lib/getBusinessProfile';
import type { MergedServiceData, RegionLocationMap } from '../../lib/types';
import { getServiceSchema, getLocalBusinessSchema } from '../../lib/schema';
import { getServiceBreadcrumbs, getServiceCityBreadcrumbs, getBreadcrumbSchema, type BreadcrumbItem } from '../../lib/breadcrumbs';
import { resolveFAQs } from '../../lib/faqResolver';
import { generateFAQSchema } from '../../lib/faqSchema';
import { getReviewsForPage } from '../../lib/reviewResolver';
import { generateReviewSchemas } from '../../lib/reviewSchema';

// Service Page Components (Section Order per spec)
import ServiceHero from '../../components/services/ServiceHero.astro';
import ServiceTrustBand from '../../components/services/ServiceTrustBand.astro';
import ServiceProblemAgitation from '../../components/services/ServiceProblemAgitation.astro';
import ServiceSolution from '../../components/services/ServiceSolution.astro';
import ServiceValueProps from '../../components/services/ServiceValueProps.astro';
import ServiceProcess from '../../components/services/ServiceProcess.astro';
import ServiceInclusions from '../../components/services/ServiceInclusions.astro';
import ServiceSavings from '../../components/services/ServiceSavings.astro';
import ServiceLocalProof from '../../components/services/ServiceLocalProof.astro';
import ServiceImageGallery from '../../components/services/ServiceImageGallery.astro';
import ServiceGuarantee from '../../components/services/ServiceGuarantee.astro';

// Shared Components
import ServicesGrid from '../../components/shared/ServicesGrid.astro';
import ReviewsCarousel from '../../components/shared/ReviewsCarousel.astro';
import FAQSection from '../../components/shared/FAQSection.astro';
import CTASection from '../../components/shared/CTASection.astro';

export async function getStaticPaths() {
  const services = await getCollection('services');
  const locations = await getCollection('locations');
  const serviceCityEntries = await getCollection('service-city');

  const paths = [];

  // Helper to remove .md extension
  const cleanSlug = (id: string) => id.replace(/\.md$/, '');

  // Generate paths for individual service pages (base pages)
  for (const service of services) {
    paths.push({
      params: {
        slug: cleanSlug(service.id)
      },
      props: {
        type: 'service',
        service,
        location: null,
        serviceCityEntry: null,
      },
    });
  }

  // Generate paths for service-city pages using the service-city collection
  for (const entry of serviceCityEntries) {
    const service = services.find(s => cleanSlug(s.id) === entry.data.serviceSlug);
    const location = locations.find(l => cleanSlug(l.id) === entry.data.locationSlug);

    if (service && location) {
      paths.push({
        params: {
          slug: `${entry.data.serviceSlug}-${entry.data.locationSlug}-on`
        },
        props: {
          type: 'service-city',
          service,
          location,
          serviceCityEntry: entry,
        },
      });
    }
  }

  return paths;
}

const { type, service, location, serviceCityEntry } = Astro.props;

// Helper to remove .md extension
const cleanSlug = (id: string) => id.replace(/\.md$/, '');

// Data merging logic for service-city pages
let mergedData: MergedServiceData;

if (type === 'service-city' && serviceCityEntry) {
  // Merge base service data with city-specific overrides
  mergedData = {
    // Start with base service data
    ...service.data,
    // Override with service-city specific data
    title: serviceCityEntry.data.title,
    seoTitle: serviceCityEntry.data.seoTitle,
    seoDescription: serviceCityEntry.data.seoDescription,
    localContext: serviceCityEntry.data.localContext,
    localProof: serviceCityEntry.data.localProof,
    // City overrides take precedence if provided, otherwise use base
    problems: serviceCityEntry.data.problems || service.data.problems,
    processSteps: serviceCityEntry.data.processSteps || service.data.processSteps,
    savings: serviceCityEntry.data.savings || service.data.savings,
    inclusions: serviceCityEntry.data.inclusions || service.data.inclusions,
  };
} else {
  mergedData = service.data;
}

// Prepare SEO data based on type
let title: string;
let description: string;
let robots: string;
let Content: AstroComponentFactory | null = null;

if (type === 'service') {
  const rendered = await service.render();
  Content = rendered.Content;
  title = service.data.seoTitle || `${service.data.title} - B.A.P Heating and Cooling`;
  description = service.data.seoDescription || service.data.description;
  robots = service.data.robots || 'index,follow';
} else if (type === 'service-city' && location && serviceCityEntry) {
  title = serviceCityEntry.data.seoTitle || `${service.data.title} in ${location.data.title}, ON - B.A.P Heating and Cooling`;
  description = serviceCityEntry.data.seoDescription || `Professional ${service.data.title.toLowerCase()} services in ${location.data.title}, Ontario. ${service.data.description}`;
  robots = service.data.robots || location.data.robots || 'index,follow';
} else {
  title = 'B.A.P Heating and Cooling';
  description = 'Professional heating and cooling services';
  robots = 'index,follow';
}

const serviceSlug = cleanSlug(service.id);
const locationSlug = location ? cleanSlug(location.id) : null;

// Get business profile and generate schema
const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Load all reviews
const allReviews = await getCollection('reviews');

// Get reviews for this page
const pageReviews = getReviewsForPage(allReviews, {
  pageType: type === 'service' ? 'service' : 'service-city',
  serviceSlug: serviceSlug,
  locationSlug: locationSlug || undefined,
  citySlug: locationSlug || undefined,
});

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(pageReviews);

// Generate breadcrumb schema
let breadcrumbItems: BreadcrumbItem[];
if (type === 'service') {
  breadcrumbItems = getServiceBreadcrumbs(service.data.title, serviceSlug);
} else if (type === 'service-city' && location) {
  const combinedSlug = `${serviceSlug}-${locationSlug}-on`;
  breadcrumbItems = getServiceCityBreadcrumbs(
    service.data.title,
    serviceSlug,
    location.data.title,
    locationSlug!,
    combinedSlug
  );
} else {
  breadcrumbItems = [];
}
const breadcrumbSchema = breadcrumbItems.length > 0
  ? getBreadcrumbSchema(breadcrumbItems, 'https://bapheating.ca')
  : null;

// Resolve FAQs for this page
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: type === 'service' ? 'service' : 'service-city',
  serviceSlug: serviceSlug,
  locationSlug: locationSlug || undefined,
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Build schema array
let schemas = [];
if (type === 'service') {
  schemas.push(getServiceSchema(profile, {
    title: service.data.title,
    description: service.data.description,
    slug: serviceSlug,
  }));
} else if (type === 'service-city' && location) {
  schemas.push(
    getLocalBusinessSchema(profile),
    getServiceSchema(
      profile,
      {
        title: service.data.title,
        description: service.data.description,
        slug: serviceSlug,
      },
      {
        title: location.data.title,
        slug: locationSlug!,
      }
    )
  );
} else {
  schemas.push(getLocalBusinessSchema(profile));
}

// Add breadcrumb schema if available
if (breadcrumbSchema) {
  schemas.push(breadcrumbSchema);
}

// Add FAQ schema if available
if (faqSchema) {
  schemas.push(faqSchema);
}

// Add review schemas if available
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;

// Get all locations and regions for service pages
let allLocations: CollectionEntry<'locations'>[] = [];
let allRegions: CollectionEntry<'regions'>[] = [];
let locationsByRegion: Map<string, RegionLocationMap> = new Map();

if (type === 'service') {
  allLocations = await getCollection('locations');
  allRegions = await getCollection('regions');

  // Group locations by region
  for (const region of allRegions) {
    const regionSlug = cleanSlug(region.id);
    const regionLocations = allLocations.filter((loc) =>
      region.data.cities.includes(cleanSlug(loc.id))
    );
    locationsByRegion.set(regionSlug, {
      region: region,
      locations: regionLocations
    });
  }
}

// Get region for service-in-city pages
let parentRegion = null;

if (type === 'service-city' && location && locationSlug) {
  allRegions = await getCollection('regions');
  parentRegion = allRegions.find((region) =>
    region.data.cities.includes(locationSlug)
  );
}
---

<BaseLayout
  title={title}
  description={description}
  robots={robots}
  schema={schema}
>
  {/* 1. ServiceHero - Contextual hero with service type styling */}
  <ServiceHero
    service={{
      title: mergedData.title,
      description: mergedData.description,
      serviceType: mergedData.serviceType || 'installation',
      category: mergedData.category,
    }}
    location={location ? { title: location.data.title, slug: locationSlug! } : undefined}
  />

  {/* 2. ServiceTrustBand - Social proof strip */}
  <ServiceTrustBand />

  {/* 3. ServiceProblemAgitation - Pain points the service solves */}
  {mergedData.problems && mergedData.problems.length > 0 && (
    <ServiceProblemAgitation
      problems={mergedData.problems}
    />
  )}

  {/* 4. ServiceSolution - How B.A.P solves the problems */}
  {mergedData.approach && (
    <ServiceSolution
      approach={mergedData.approach}
    />
  )}

  {/* 5. ServiceValueProps - Key benefits/differentiators */}
  {mergedData.valueProps && mergedData.valueProps.length > 0 && (
    <ServiceValueProps
      valueProps={mergedData.valueProps}
    />
  )}

  {/* 6. ServiceProcess - Step-by-step workflow */}
  {mergedData.processSteps && mergedData.processSteps.length > 0 && (
    <ServiceProcess
      processSteps={mergedData.processSteps}
      serviceTitle={mergedData.title}
    />
  )}

  {/* 7. ServiceInclusions - What's included in the service */}
  {mergedData.inclusions && (
    <ServiceInclusions
      inclusions={mergedData.inclusions}
    />
  )}

  {/* 8. ServiceSavings - Energy/cost savings messaging */}
  {mergedData.savings && (
    <ServiceSavings
      savings={mergedData.savings}
    />
  )}

  {/* 9. ServiceLocalProof - Local testimonial (service-city pages only) */}
  {type === 'service-city' && mergedData.localProof && location && (
    <ServiceLocalProof
      localProof={mergedData.localProof}
      locationTitle={location.data.title}
    />
  )}

  {/* 10. ServiceImageGallery - Project photos */}
  {mergedData.images && mergedData.images.length > 0 && (
    <ServiceImageGallery
      images={mergedData.images}
      title="Our Recent Work"
      eyebrow="Project Gallery"
    />
  )}

  {/* 11. ServicesGrid - Related services in same category */}
  <ServicesGrid
    filterByCategory={mergedData.category}
    locationSlug={locationSlug || undefined}
    columns={3}
    limit={6}
    title="Related Services"
    eyebrow="More Solutions"
    description="Explore our other professional HVAC services"
  />

  {/* 12. ReviewsCarousel - Customer testimonials */}
  <ReviewsCarousel
    filterBy={{
      serviceSlug: serviceSlug,
      locationSlug: locationSlug || undefined,
    }}
    limit={8}
    title="What Our Customers Say"
  />

  {/* 13. ServiceGuarantee - Trust and guarantee section */}
  {mergedData.guarantee && (
    <ServiceGuarantee
      guarantee={mergedData.guarantee}
    />
  )}

  {/* 14. FAQSection - Page-specific FAQs */}
  {pageFAQs && pageFAQs.length > 0 && (
    <FAQSection
      faqs={pageFAQs.map(faq => ({
        question: faq.data.question,
        answer: faq.data.answer,
      }))}
      title="Frequently Asked Questions"
      eyebrow="Got Questions?"
      showCTA={true}
      ctaHeadline="Can't find your answer?"
      ctaLabel="Contact Us"
      ctaHref="/contact-us/"
      includeSchema={false}
    />
  )}

  {/* 15. CTASection - Final conversion section */}
  <CTASection
    variant={mergedData.serviceType === 'repair' ? 'emergency' : 'primary'}
    headline={type === 'service-city' && location
      ? `Ready for Professional ${mergedData.title} in ${location.data.title}?`
      : `Ready for Professional ${mergedData.title}?`
    }
    description="Our certified technicians are ready to help. Call now for fast, reliable service."
    primaryCTA={{
      label: mergedData.serviceType === 'repair' ? 'Emergency Service' : 'Get a Free Quote',
      href: '/contact-us/',
    }}
    secondaryCTA={{
      label: 'Call (905) 301-2195',
      href: 'tel:+19053012195',
    }}
    showPhone={true}
  />
</BaseLayout>
