---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ReviewsBlock from '../../components/ReviewsBlock.astro';
import FAQSection from '../../components/shared/FAQSection.astro';
import Section from '../../components/primitives/Section.astro';
// Service page components
import ServiceHero from '../../components/services/ServiceHero.astro';
import ServiceTrustBand from '../../components/services/ServiceTrustBand.astro';
import ServiceValueProps from '../../components/services/ServiceValueProps.astro';
import ServiceFinalCTA from '../../components/services/ServiceFinalCTA.astro';
// New full-funnel components
import ServiceProblemAgitation from '../../components/services/ServiceProblemAgitation.astro';
import ServiceSolution from '../../components/services/ServiceSolution.astro';
import ServiceProcess from '../../components/services/ServiceProcess.astro';
import ServiceInclusions from '../../components/services/ServiceInclusions.astro';
import ServiceSavings from '../../components/services/ServiceSavings.astro';
import ServiceGuarantee from '../../components/services/ServiceGuarantee.astro';
import ServiceLocalProof from '../../components/services/ServiceLocalProof.astro';
import ServiceImageGallery from '../../components/services/ServiceImageGallery.astro';

import { getCollection } from 'astro:content';
import { getBusinessProfile } from '../../lib/getBusinessProfile';
import { getServiceSchema, getLocalBusinessSchema } from '../../lib/schema';
import { getServiceBreadcrumbs, getServiceCityBreadcrumbs, getBreadcrumbSchema, type BreadcrumbItem } from '../../lib/breadcrumbs';
import { resolveFAQs } from '../../lib/faqResolver';
import { generateFAQSchema } from '../../lib/faqSchema';
import { getReviewsForPage } from '../../lib/reviewResolver';
import { generateReviewSchemas } from '../../lib/reviewSchema';

export async function getStaticPaths() {
  const services = await getCollection('services');
  const locations = await getCollection('locations');
  const serviceCityEntries = await getCollection('service-city');

  const paths = [];

  // Helper to remove .md extension
  const cleanSlug = (id: string) => id.replace(/\.md$/, '');

  // Generate paths for individual service pages (base pages)
  for (const service of services) {
    paths.push({
      params: {
        slug: cleanSlug(service.id)
      },
      props: {
        type: 'service',
        service,
        location: null,
        serviceCityEntry: null,
      },
    });
  }

  // Generate paths for service-city pages using the service-city collection
  for (const entry of serviceCityEntries) {
    const service = services.find(s => cleanSlug(s.id) === entry.data.serviceSlug);
    const location = locations.find(l => cleanSlug(l.id) === entry.data.locationSlug);

    if (service && location) {
      paths.push({
        params: {
          slug: `${entry.data.serviceSlug}-${entry.data.locationSlug}-on`
        },
        props: {
          type: 'service-city',
          service,
          location,
          serviceCityEntry: entry,
        },
      });
    }
  }

  return paths;
}

const { type, service, location, serviceCityEntry } = Astro.props;

// Helper to remove .md extension
const cleanSlug = (id: string) => id.replace(/\.md$/, '');

// Data merging logic for service-city pages
let mergedData: any;

if (type === 'service-city' && serviceCityEntry) {
  // Merge base service data with city-specific overrides
  mergedData = {
    // Start with base service data
    ...service.data,
    // Override with service-city specific data
    title: serviceCityEntry.data.title,
    seoTitle: serviceCityEntry.data.seoTitle,
    seoDescription: serviceCityEntry.data.seoDescription,
    localContext: serviceCityEntry.data.localContext,
    localProof: serviceCityEntry.data.localProof,
    // City overrides take precedence if provided, otherwise use base
    problems: serviceCityEntry.data.problems || service.data.problems,
    processSteps: serviceCityEntry.data.processSteps || service.data.processSteps,
    savings: serviceCityEntry.data.savings || service.data.savings,
    inclusions: serviceCityEntry.data.inclusions || service.data.inclusions,
  };
} else {
  mergedData = service.data;
}

// Prepare SEO data based on type
let title: string;
let description: string;
let robots: string;
let Content: any = null;

if (type === 'service') {
  const rendered = await service.render();
  Content = rendered.Content;
  title = service.data.seoTitle || `${service.data.title} - B.A.P Heating and Cooling`;
  description = service.data.seoDescription || service.data.description;
  robots = service.data.robots || 'index,follow';
} else if (type === 'service-city' && location && serviceCityEntry) {
  title = serviceCityEntry.data.seoTitle || `${service.data.title} in ${location.data.title}, ON - B.A.P Heating and Cooling`;
  description = serviceCityEntry.data.seoDescription || `Professional ${service.data.title.toLowerCase()} services in ${location.data.title}, Ontario. ${service.data.description}`;
  robots = service.data.robots || location.data.robots || 'index,follow';
} else {
  title = 'B.A.P Heating and Cooling';
  description = 'Professional heating and cooling services';
  robots = 'index,follow';
}

const serviceSlug = cleanSlug(service.id);
const locationSlug = location ? cleanSlug(location.id) : null;

// Get business profile and generate schema
const profile = await getBusinessProfile();

// Load all FAQs
const allFAQs = await getCollection('faqs');

// Load all reviews
const allReviews = await getCollection('reviews');

// Get reviews for this page
const pageReviews = getReviewsForPage(allReviews, {
  pageType: type === 'service' ? 'service' : 'service-city',
  serviceSlug: serviceSlug,
  locationSlug: locationSlug || undefined,
  citySlug: locationSlug || undefined,
});

// Generate review schemas (only for verified reviews)
const reviewSchemas = generateReviewSchemas(pageReviews);

// Generate breadcrumb schema
let breadcrumbItems: BreadcrumbItem[];
if (type === 'service') {
  breadcrumbItems = getServiceBreadcrumbs(service.data.title, serviceSlug);
} else if (type === 'service-city' && location) {
  const combinedSlug = `${serviceSlug}-${locationSlug}-on`;
  breadcrumbItems = getServiceCityBreadcrumbs(
    service.data.title,
    serviceSlug,
    location.data.title,
    locationSlug!,
    combinedSlug
  );
} else {
  breadcrumbItems = [];
}
const breadcrumbSchema = breadcrumbItems.length > 0
  ? getBreadcrumbSchema(breadcrumbItems, 'https://bapheating.ca')
  : null;

// Resolve FAQs for this page
const pageFAQs = resolveFAQs(allFAQs, {
  pageType: type === 'service' ? 'service' : 'service-city',
  serviceSlug: serviceSlug,
  locationSlug: locationSlug || undefined,
});

// Generate FAQ schema if FAQs exist
const faqSchema = generateFAQSchema(pageFAQs);

// Build schema array
let schemas = [];
if (type === 'service') {
  schemas.push(getServiceSchema(profile, {
    title: service.data.title,
    description: service.data.description,
    slug: serviceSlug,
  }));
} else if (type === 'service-city' && location) {
  schemas.push(
    getLocalBusinessSchema(profile),
    getServiceSchema(
      profile,
      {
        title: service.data.title,
        description: service.data.description,
        slug: serviceSlug,
      },
      {
        title: location.data.title,
        slug: locationSlug!,
      }
    )
  );
} else {
  schemas.push(getLocalBusinessSchema(profile));
}

// Add breadcrumb schema if available
if (breadcrumbSchema) {
  schemas.push(breadcrumbSchema);
}

// Add FAQ schema if available
if (faqSchema) {
  schemas.push(faqSchema);
}

// Add review schemas if available
if (reviewSchemas.length > 0) {
  schemas.push(...reviewSchemas);
}

const schema = schemas;

// Get all locations and regions for service pages
let allLocations: any[] = [];
let allRegions: any[] = [];
let locationsByRegion: Map<string, { region: any; locations: any[] }> = new Map();

if (type === 'service') {
  allLocations = await getCollection('locations');
  allRegions = await getCollection('regions');

  // Group locations by region
  for (const region of allRegions) {
    const regionSlug = cleanSlug(region.id);
    const regionLocations = allLocations.filter((loc) =>
      region.data.cities.includes(cleanSlug(loc.id))
    );
    locationsByRegion.set(regionSlug, {
      region: region,
      locations: regionLocations
    });
  }
}

// Get all services for service-in-city pages
let allServices: any[] = [];
let relatedServices: any[] = [];

if (type === 'service-city') {
  allServices = await getCollection('services');
  relatedServices = allServices.filter((s) => cleanSlug(s.id) !== serviceSlug);
}

// Get region for service-in-city pages
let parentRegion = null;

if (type === 'service-city' && location && locationSlug) {
  allRegions = await getCollection('regions');
  parentRegion = allRegions.find((region) =>
    region.data.cities.includes(locationSlug)
  );
}
---

<BaseLayout
  title={title}
  description={description}
  robots={robots}
  schema={schema}
>
  {type === 'service' ? (
    <>
      {/* 1. Hero Section */}
      <ServiceHero
        title={service.data.title}
        description={service.data.description}
        category={service.data.category}
        serviceType={service.data.serviceType || 'installation'}
      />

      {/* 2. Trust Band */}
      <ServiceTrustBand />

      {/* 3. Problem Agitation - NEW */}
      {mergedData.problems && mergedData.problems.length > 0 && (
        <ServiceProblemAgitation
          serviceTitle={service.data.title}
          problems={mergedData.problems}
        />
      )}

      {/* 4. Solution/Approach - NEW */}
      {mergedData.approach && (
        <ServiceSolution
          serviceTitle={service.data.title}
          approach={mergedData.approach}
        />
      )}

      {/* 5. Value Props */}
      <ServiceValueProps
        serviceTitle={service.data.title}
        valueProps={service.data.valueProps}
      />

      {/* 6. Process Steps - NEW */}
      {mergedData.processSteps && mergedData.processSteps.length > 0 && (
        <ServiceProcess
          serviceTitle={service.data.title}
          processSteps={mergedData.processSteps}
        />
      )}

      {/* 7. What's Included - NEW */}
      {mergedData.inclusions && (
        <ServiceInclusions
          serviceTitle={service.data.title}
          inclusions={mergedData.inclusions}
        />
      )}

      {/* 8. Savings - NEW */}
      {mergedData.savings && (
        <ServiceSavings
          serviceTitle={service.data.title}
          savings={mergedData.savings}
        />
      )}

      {/* 9. Image Gallery - NEW */}
      {mergedData.images && mergedData.images.length > 0 && (
        <ServiceImageGallery
          serviceTitle={service.data.title}
          images={mergedData.images}
        />
      )}

      {/* 10. Service Areas Section */}
      <Section variant="default">
        <div class="mb-10 text-center">
          <p class="eyebrow mb-3">Service Coverage</p>
          <h2 class="section-title mx-auto mb-4 max-w-3xl">
            {service.data.title} Service Areas in Ontario
          </h2>
          <p class="mx-auto max-w-2xl text-base text-muted-foreground">
            We proudly serve homeowners across Southern Ontario. Find {service.data.title.toLowerCase()} services in your area.
          </p>
        </div>
        {Array.from(locationsByRegion.entries()).map(([_, { region, locations }]) => (
          <div class="mb-10">
            <h3 class="mb-4 text-xl font-semibold">{region.data.title}</h3>
            <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4">
              {locations.map((loc: any) => (
                <a
                  href={`/services/${serviceSlug}-${cleanSlug(loc.id)}-on/`}
                  class="rounded-lg border border-border bg-background px-4 py-3 text-center text-sm font-medium transition-colors hover:border-primary hover:bg-primary/5"
                >
                  {loc.data.title}
                </a>
              ))}
            </div>
          </div>
        ))}
      </Section>

      {/* 11. Reviews Section */}
      <ReviewsBlock reviews={pageReviews} title={`${service.data.title} Customer Reviews`} />

      {/* 12. Guarantee - NEW */}
      {mergedData.guarantee && (
        <ServiceGuarantee
          serviceTitle={service.data.title}
          guarantee={mergedData.guarantee}
        />
      )}

      {/* 13. FAQs */}
      {pageFAQs.length > 0 && (
        <FAQSection faqs={pageFAQs} />
      )}

      {/* 14. Final CTA */}
      <ServiceFinalCTA
        serviceTitle={service.data.title}
        serviceType={service.data.serviceType || 'installation'}
      />
    </>
  ) : location ? (
    <>
      {/* 1. Hero Section with Location */}
      <ServiceHero
        title={service.data.title}
        description={service.data.description}
        category={service.data.category}
        serviceType={service.data.serviceType || 'installation'}
        location={{ title: location.data.title, slug: locationSlug! }}
      />

      {/* 2. Trust Band */}
      <ServiceTrustBand />

      {/* 3. Problem Agitation - NEW */}
      {mergedData.problems && mergedData.problems.length > 0 && (
        <ServiceProblemAgitation
          serviceTitle={service.data.title}
          location={{ title: location.data.title }}
          problems={mergedData.problems}
        />
      )}

      {/* 4. Solution/Approach - NEW */}
      {mergedData.approach && (
        <ServiceSolution
          serviceTitle={service.data.title}
          location={{ title: location.data.title }}
          approach={mergedData.approach}
        />
      )}

      {/* 5. Value Props */}
      <ServiceValueProps
        serviceTitle={service.data.title}
        valueProps={service.data.valueProps}
        location={{ title: location.data.title }}
      />

      {/* 6. Process Steps - NEW */}
      {mergedData.processSteps && mergedData.processSteps.length > 0 && (
        <ServiceProcess
          serviceTitle={service.data.title}
          location={{ title: location.data.title }}
          processSteps={mergedData.processSteps}
        />
      )}

      {/* 7. What's Included - NEW */}
      {mergedData.inclusions && (
        <ServiceInclusions
          serviceTitle={service.data.title}
          inclusions={mergedData.inclusions}
        />
      )}

      {/* 8. Savings - NEW */}
      {mergedData.savings && (
        <ServiceSavings
          serviceTitle={service.data.title}
          location={{ title: location.data.title }}
          savings={mergedData.savings}
        />
      )}

      {/* 9. Image Gallery - NEW */}
      {mergedData.images && mergedData.images.length > 0 && (
        <ServiceImageGallery
          serviceTitle={service.data.title}
          images={mergedData.images}
        />
      )}

      {/* 10. Related Services in This Location */}
      <Section variant="default">
        <div class="mb-10 text-center">
          <p class="eyebrow mb-3">More Services</p>
          <h2 class="section-title mx-auto mb-4 max-w-3xl">
            Other HVAC Services in {location.data.title}, Ontario
          </h2>
          <p class="mx-auto max-w-2xl text-base text-muted-foreground">
            We offer a full range of heating, cooling, and air quality services in {location.data.title}.
          </p>
        </div>
        <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4">
          {relatedServices.slice(0, 12).map((relatedService: any) => (
            <a
              href={`/services/${cleanSlug(relatedService.id)}-${locationSlug}-on/`}
              class="rounded-lg border border-border bg-background px-4 py-3 text-center text-sm font-medium transition-colors hover:border-primary hover:bg-primary/5"
            >
              {relatedService.data.title}
            </a>
          ))}
        </div>
        <div class="mt-6 text-center">
          <a
            href={`/locations/${locationSlug}/`}
            class="inline-flex items-center gap-1 text-primary hover:underline"
          >
            View all services in {location.data.title}
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </Section>

      {/* 11. Local Proof - NEW (city pages only) */}
      {mergedData.localProof && (
        <ServiceLocalProof
          serviceTitle={service.data.title}
          location={{ title: location.data.title }}
          localProof={mergedData.localProof}
        />
      )}

      {/* 12. Reviews Section */}
      <ReviewsBlock reviews={pageReviews} title={`${service.data.title} Reviews in ${location.data.title}`} />

      {/* 13. Guarantee - NEW */}
      {mergedData.guarantee && (
        <ServiceGuarantee
          serviceTitle={service.data.title}
          guarantee={mergedData.guarantee}
        />
      )}

      {/* 14. FAQs */}
      {pageFAQs.length > 0 && (
        <FAQSection faqs={pageFAQs} />
      )}

      {/* 15. Final CTA */}
      <ServiceFinalCTA
        serviceTitle={service.data.title}
        serviceType={service.data.serviceType || 'installation'}
        location={{ title: location.data.title }}
      />
    </>
  ) : null}
</BaseLayout>
