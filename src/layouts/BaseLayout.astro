---
/**
 * BaseLayout - Main Site Layout
 *
 * The foundational layout wrapper for all pages. Includes:
 * - SEO meta tags and structured data
 * - Header with navigation
 * - Footer with contact info and links
 * - Floating CTA for mobile
 */

import '../styles/global.css';
import { getBusinessProfile, getCompanyName } from '../lib/getBusinessProfile';

// Layout Components
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import FloatingCTA from '../components/shared/FloatingCTA.astro';
import SeasonalCalloutBar from '../components/layout/SeasonalCalloutBar.astro';
import { getCanonicalUrl } from '../lib/urlGovernance';

export interface Props {
  title?: string;
  description?: string;
  canonicalURL?: string;
  robots?: string;
  schema?: object | object[];
  ogImage?: string;
}

const profile = await getBusinessProfile();
const companyName = getCompanyName(profile);

const {
  title = companyName,
  description = 'Professional heating and cooling services',
  canonicalURL,
  robots = 'index,follow',
  schema,
  ogImage,
} = Astro.props;

// OG Image - use provided or default
const siteUrl = import.meta.env.SITE || 'https://bapheating.ca';
const defaultOgImage = `${siteUrl}/og-image.svg`;
const ogImageUrl = ogImage ? (ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`) : defaultOgImage;

// Get canonical URL using governance helper
const canonicalUrl = canonicalURL || getCanonicalUrl(Astro.url.pathname);

// Environment-based indexing control
const environment = import.meta.env.PUBLIC_ENVIRONMENT || 'production';
const isProduction = environment === 'production';

// Override robots for staging
const effectiveRobots = isProduction ? robots : 'noindex,nofollow';

// GA4 Configuration
const ga4Id = import.meta.env.PUBLIC_GA4_ID;
const enableGA4 = import.meta.env.PROD && ga4Id && isProduction;
---

<!doctype html>
<html lang="en-CA">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <meta name="robots" content={effectiveRobots} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Google Fonts: Inter (preconnect for performance) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- SEO -->
    <title>{title}</title>

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="B.A.P Heating & Cooling - 24/7 HVAC Service in Guelph & Ontario" />
    <meta property="og:site_name" content="B.A.P Heating & Cooling" />
    <meta property="og:locale" content="en_CA" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content="B.A.P Heating & Cooling - 24/7 HVAC Service in Guelph & Ontario" />

    <!-- Structured Data (JSON-LD) -->
    {schema && (
      <script type="application/ld+json" set:html={JSON.stringify(
        Array.isArray(schema) ? schema : [schema]
      )} />
    )}

    <!-- Google Analytics 4 -->
    {enableGA4 && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga4Id}`}></script>
        <script is:inline define:vars={{ ga4Id }}>
          // Initialize Google Analytics 4 with consent management
          const CONSENT_KEY = 'bap_analytics_consent';

          function getAnalyticsConsent() {
            try {
              const stored = localStorage.getItem(CONSENT_KEY);
              if (stored === 'granted' || stored === 'denied') {
                return stored;
              }
            } catch (e) {
              console.warn('Failed to read analytics consent:', e);
            }
            return 'granted'; // Default: granted
          }

          const consent = getAnalyticsConsent();

          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }

          gtag('consent', 'default', {
            'analytics_storage': consent,
            'ad_storage': consent,
            'wait_for_update': 500
          });

          gtag('js', new Date());
          gtag('config', ga4Id, {
            'send_page_view': true,
            'anonymize_ip': true
          });

          console.info('GA4 initialized:', ga4Id, 'consent:', consent);
        </script>
      </>
    )}
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">
      Skip to main content
    </a>

    <div class="site-wrapper">
      <!-- Header -->
      <Header showTopBar={true} />

      <!-- Seasonal Callout Bar (displays date-based promotional messages) -->
      <SeasonalCalloutBar />

      <!-- Main Content -->
      <main id="main-content" role="main" class="site-main">
        <slot />
      </main>

      <!-- Footer -->
      <Footer />
    </div>

    <!-- Mobile Floating CTA -->
    <FloatingCTA variant="call" />
  </body>
</html>
