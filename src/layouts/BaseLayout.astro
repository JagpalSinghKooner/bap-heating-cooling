---
/**
 * BaseLayout - Gutted for Redesign
 *
 * This preserves all head/meta logic for SEO.
 * Visual components will be rebuilt during Phase 3.
 */

import '../styles/global.css';
import { getBusinessProfile, getCompanyName, getPhoneDisplay, getPhoneLink, getEmail, getEmailLink } from '../lib/getBusinessProfile';
import { getCanonicalUrl } from '../lib/urlGovernance';

export interface Props {
  title?: string;
  description?: string;
  canonicalURL?: string;
  robots?: string;
  schema?: object | object[];
  ogImage?: string;
}

const profile = await getBusinessProfile();
const companyName = getCompanyName(profile);

const {
  title = companyName,
  description = 'Professional heating and cooling services',
  canonicalURL,
  robots = 'index,follow',
  schema,
  ogImage,
} = Astro.props;

// OG Image - use provided or default
const siteUrl = import.meta.env.SITE || 'https://bapheating.ca';
const defaultOgImage = `${siteUrl}/og-image.svg`;
const ogImageUrl = ogImage ? (ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`) : defaultOgImage;

// Get canonical URL using governance helper
const canonicalUrl = canonicalURL || getCanonicalUrl(Astro.url.pathname);

// Environment-based indexing control
const environment = import.meta.env.PUBLIC_ENVIRONMENT || 'production';
const isProduction = environment === 'production';

// Override robots for staging
const effectiveRobots = isProduction ? robots : 'noindex,nofollow';

// GA4 Configuration
const ga4Id = import.meta.env.PUBLIC_GA4_ID;
const enableGA4 = import.meta.env.PROD && ga4Id && isProduction;
---

<!doctype html>
<html lang="en-CA">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <meta name="robots" content={effectiveRobots} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- SEO -->
    <title>{title}</title>

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="B.A.P Heating & Cooling - 24/7 HVAC Service in Guelph & Ontario" />
    <meta property="og:site_name" content="B.A.P Heating & Cooling" />
    <meta property="og:locale" content="en_CA" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content="B.A.P Heating & Cooling - 24/7 HVAC Service in Guelph & Ontario" />

    <!-- Structured Data (JSON-LD) -->
    {schema && (
      <script type="application/ld+json" set:html={JSON.stringify(
        Array.isArray(schema) ? schema : [schema]
      )} />
    )}

    <!-- Google Analytics 4 -->
    {enableGA4 && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga4Id}`}></script>
        <script is:inline define:vars={{ ga4Id }}>
          // Initialize Google Analytics 4 with consent management
          const CONSENT_KEY = 'bap_analytics_consent';

          function getAnalyticsConsent() {
            try {
              const stored = localStorage.getItem(CONSENT_KEY);
              if (stored === 'granted' || stored === 'denied') {
                return stored;
              }
            } catch (e) {
              console.warn('Failed to read analytics consent:', e);
            }
            return 'granted'; // Default: granted
          }

          const consent = getAnalyticsConsent();

          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }

          gtag('consent', 'default', {
            'analytics_storage': consent,
            'ad_storage': consent,
            'wait_for_update': 500
          });

          gtag('js', new Date());
          gtag('config', ga4Id, {
            'send_page_view': true,
            'anonymize_ip': true
          });

          console.info('GA4 initialized:', ga4Id, 'consent:', consent);
        </script>
      </>
    )}
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-primary focus:text-primary-foreground">
      Skip to main content
    </a>

    <div class="flex min-h-screen flex-col">
      <!-- Header placeholder - will be rebuilt in Phase 3 -->
      <header role="banner" class="bg-slate-900 text-white p-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
          <a href="/" class="text-xl font-bold">{companyName}</a>
          <a href={getPhoneLink(profile)} class="text-sm hover:underline">
            {getPhoneDisplay(profile)}
          </a>
        </div>
      </header>

      <!-- Main Content -->
      <main id="main-content" role="main" class="flex-1">
        <slot />
      </main>

      <!-- Footer placeholder - will be rebuilt in Phase 3 -->
      <footer class="bg-slate-900 text-slate-300 p-8" role="contentinfo">
        <div class="max-w-6xl mx-auto text-center">
          <p class="mb-2">{companyName}</p>
          <p class="text-sm">
            <a href={getPhoneLink(profile)} class="hover:text-white">{getPhoneDisplay(profile)}</a>
            {' | '}
            <a href={getEmailLink(profile)} class="hover:text-white">{getEmail(profile)}</a>
          </p>
          <p class="text-xs text-slate-500 mt-4">
            &copy; {new Date().getFullYear()} {profile.business.legal_name}. All rights reserved.
          </p>
        </div>
      </footer>
    </div>
  </body>
</html>
